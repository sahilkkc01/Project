<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>LifeLinker</title>
    <%- include('../header'); -%>


        <!-- //header-ends -->
        <!-- main content start -->
        <div class="main-content">

            <div class="row content-top-gap2">
                <div class="col-lg-12">
                    <nav class="navbar navbar-expand-lg navbar-light bg-white">
                        <a class="navbar-brand text-center mr-5" href="#">
                            <span class="dash-icon"><i class="fas fa-tachometer-alt"></i></span>
                            Dashboard
                        </a>
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarNav">
                            <ul class="navbar-nav">
                                <li class="nav-item active text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="far fa-user"></i></span>
                                        Master
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-exchange-alt"></i></span>
                                        Transaction
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-hand-holding-medical"></i></span>
                                        Patient 360
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-receipt"></i></span>
                                        Outside Reciept
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-file-invoice"></i></span>
                                        Outpatient Department
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-chart-line"></i></span>
                                        Analytics
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="far fa-clock"></i></span>
                                        Waiting List
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-wrench"></i></span>
                                        Adminstration
                                    </a>
                                </li>
                                <li class="nav-item text-center">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-spinner"></i></span>
                                        Additional
                                    </a>
                                </li>

                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
            <!-- content -->
            <div class="container-fluid">

                <div class="chart">
                    <div id="errordiv1"></div>
                    <form id="selService" method="post">
                        <input type="hidden" name="query" id="query" value="0">
                        
                    <div class="row">

                        <div class="col-lg-12 pl-lg-0 mt-2 ml-2">
                            <h4 class="primary">Service Rate - Doctor Category Wise</h4>
                        </div>
                
                        <div class="col-lg-12 pl-lg-2 chart-grid">
                            
                                <div class="card card_border">
                                    <div>
                                        <!--Past your code here starts-->

                                        <div class="card">

                                            <!-- <div class="card-body"> -->
                                                
                                                <div class="form-row pl-lg-3 pr-lg-4 mt-1 mb-2">
                                                    <div class="col-lg-6 col-md-4 col-sm-3">
                                                        <div class="form-group"><label
                                                            class="input__label">Doctor Category</label><select name="docCategory" id="docCategory"   id="docCategory"  data-validation="required" data-error-message="Doctor Category is Required"
                                                            class="form-control input-style">
                                                            <option value="">Select</option>
                                                        </select>
                                                    </div>  
                                                    </div>  
                                                    
                                                </div>

                                                


                                            <!-- </div> -->
                                        </div>
                                        <!--Past your code here ends-->
                                    </div>
                                </div>
                        </div>
                        <!--section2-->
                        <div class="mt-1 col-lg-6 pl-lg-2">
                            <div class="card card_border">
                                <div class="mb-3">
                                    <div class="form-group">
                                        <div class="col-xl-12 p-heading">
                                            <h6 class="p-text">LIST OF SERVICES</h6>
                                        </div>
                                    </div>
                                </div>
                        
                                <div class="form-row">
                                    <div class="col-12 mb-1">
                                        <div class="form-group">
                                            <div class="pr-xl-0 pl-xl-3">
                                                <h6 class="primary">Advance Filter</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        
                                <div class="form-row pr-xl-3 pl-xl-3">
                                    <div class="col-6 mb-3">
                                        <div class="form-group">
                                            <label class="input__label">Service Name</label>
                                            <input name="service_name" id="searchBox" type="text" class="form-control input-style" placeholder="" >
                                        </div>
                                    </div>
                                </div>
                        
                                <div class="form-row">
                                    <div class="col-12 mb-3 pl-lg-3 pr-lg-3">
                                        <div class="slidx">
                                            <table class="table2" id="servicesTable">
                                                <thead>
                                                    <tr>
                                                        <th>Select</th>
                                                        <th>Service Name</th>
                                                        <th>Class Name</th>
                                                        <th>Service Rate</th>
                                                    </tr>
                                                </thead>
                                                <tbody  id="tblbody">
                                                    <tr>
                                                        <td><input class="form-check-input mt-1 td" type="checkbox" value="<%= result.status %>" <%= result.id ? 'disabled' : '' %>
                                                            </td>
                                                        <td>Cervical Biopsy</td>
                                                        <td>Self</td>
                                                        <td>Self</td>
                                                    </tr>
                                                    <tr>
                                                        <td><input class="form-check-input mt-1 td" type="checkbox" <%= result.id ? 'disabled' : '' %>
                                                            <%= result.status ? 'checked' : '' %>
                                                            >
                                                            </td>
                                                        <td>Cervical Smear</td>
                                                        <td>Neo Soft</td>
                                                        <td>Neo Soft</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <div id="paginationControls"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-1 col-lg-6">
                            <div class="card card_border">
                                <div class="mb-3">
                                    <div class="form-group">
                                        <div class="col-xl-12 p-heading">
                                            <h6 class="p-text">LIST OF SELECTED SERVICES</h6>
                                        </div>
                                    </div>
                                </div>
                        
                                <div class="form-row">
                                    <div class="col-12 mb-3 pl-lg-3 pr-lg-3">
                                        <div class="slidx">
                                            <table class="table2" id="selectedServicesTable">
                                                <thead>
                                                    <tr>
                                                        <th>Service Name</th>   
                                                        <th>Class Name</th>
                                                        <th>Service Rate</th>
                                                        <th>Delete</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr <%= result.id ? 'disable' : 'hidden' %>>
                                                        <td contenteditable="true" ><%= result.serviceName %></td>
                                                        <td contenteditable="true"><%= result.className %></td>
                                                        <td contenteditable="true"><%= result.serviceRate %></td>
                                                        <td contenteditable="true"> <button class="btn btn-danger btn-sm delete-btn td"   <%= result.id ? 'disabled' : '' %> data-service-name="${serviceName}">Delete</button></td>
                                                    </tr>
                                                    <tr hidden>
                                                        <td contenteditable="true"></td>
                                                        <td contenteditable="true"></td>
                                                        <td contenteditable="true"></td>
                                                        <td contenteditable="true"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mt-1 mb-3 text-right">

                        <button type="button" class="btn-success btn-style btn mt-3 mr-2" id="mod-btn" onclick="updateQuery()"><strong><i
                                    class="fa-regular fa-pen-to-square" ></i> Modify</strong></button>

                        <button type="button" class="btn-secondary btn-style btn mt-3 mr-2"disabled><strong><i
                                    class="fa-solid fa-plus" ></i> New</strong></button>

                       <button type="button" class="btn-danger btn-style btn mt-3 mr-2" onclick="window.location.href='/billing/13'"><strong><i
                                        class="fas fa-times"></i>Cancel</strong></button>            

                        <button type="submit" class="btn-primary btn-style btn mt-3" id="submit" <%= result.id ? 'disabled' : '' %>><strong><i class="far fa-save"></i>
                                Save</strong></button>
                    </div>
                    </form>

                </div>
                <!--footer section start-->
                <%- include('../footer'); -%>

                <script>
                    var selectedServices = [];
                    const itemid = '<%= result.id %>'; // This is a server-side templating example (e.g., using EJS).
const query = $('#query').val(); 
 // jQuery method to get the value of the 'query' input field.

                    selectedServices[0] = { itemid:itemid, query:query }; // Initialize with server-side values
                
                    function updateQuery() {
                        selectedServices[0].query = 1; // Set query to 1 in the array
                        console.log(selectedServices);
                
                        document.getElementById('query').value = 1; // Update the value in the DOM
                        $('#mod-btn').prop('disabled', true);
                        $('.td').prop('disabled', false);
                        $('#code').prop('disabled', true);
                        document.getElementById('submit').disabled = false;
                        $('#docCategory').prop('disabled', false);
                        console.log('Query updated:', selectedServices[0].query); // Log to console for verification
                    }
                
                    if ('<%= result.id %>' !== '') {
                        $('input[data-validation], select[data-validation] #selectedServicesTable ').prop('disabled', true);
                    } 
                    if('<%= result.status %>'!=='true'){
        document.getElementById('mod-btn').disabled = true;
      }else {
    
                 
                        document.getElementById('submit').disabled = false;
                    
                    }
                </script>
                
 
<script type="module">
    import { pagi_search } from '../javascripts/pagi_search.js';
    import { validateForm } from '../javascripts/validation.js';
    import { myAjax } from '../javascripts/myAjax.js';

    $(document).ready(function() {
        var jsonData = [
 { "id": 1, "clinic_id": "0", "doc_cat_master_code": "1", "doc_cat_master_desc": "Consultant" },
 { "id": 2, "clinic_id": "0", "doc_cat_master_code": "2", "doc_cat_master_desc": "Senior Consultant" },
 { "id": 3, "clinic_id": "0", "doc_cat_master_code": "3", "doc_cat_master_desc": "Counsellor" },
 { "id": 4, "clinic_id": "0", "doc_cat_master_code": "4", "doc_cat_master_desc": "Laparoscopic Surgeon" },
 { "id": 5, "clinic_id": "0", "doc_cat_master_code": "5", "doc_cat_master_desc": "Embryologist" },
 { "id": 6, "clinic_id": "0", "doc_cat_master_code": "1", "doc_cat_master_desc": "Consultant" },
 { "id": 7, "clinic_id": "0", "doc_cat_master_code": "2", "doc_cat_master_desc": "Senior Consultant" },
 { "id": 8, "clinic_id": "0", "doc_cat_master_code": "3", "doc_cat_master_desc": "Counsellor" },
 { "id": 9, "clinic_id": "0", "doc_cat_master_code": "4", "doc_cat_master_desc": "Laparoscopic Surgeon" },
 { "id": 10, "clinic_id": "0", "doc_cat_master_code": "5", "doc_cat_master_desc": "Embryologist" },
 { "id": 11, "clinic_id": "0", "doc_cat_master_code": "10", "doc_cat_master_desc": "ABC" },
 { "id": 12, "clinic_id": "0", "doc_cat_master_code": "A", "doc_cat_master_desc": "A" },
 { "id": 13, "clinic_id": "0", "doc_cat_master_code": "99a", "doc_cat_master_desc": "descj" }
];
var $docCategorySelect = $('#docCategory');
    var selectedCategory = '<%= result.docCategory %>'; // Embed EJS variable
    var itemId = '<%= result.id %>'; // Embed EJS variable
    console.log(selectedCategory+itemId)

    jsonData.forEach(item => {
    var isSelected = (selectedCategory === item.doc_cat_master_desc);
   

    $docCategorySelect.append($('<option>', {
        value: item.doc_cat_master_desc,
        text: item.doc_cat_master_desc,
        selected: isSelected
    }));
});

    // Disable the select if itemId is not empty    
    if (itemId) {
        $docCategorySelect.prop('disabled', true);
    }

// Define selectedServices array globally if not already defined
function fetchServices() {
            $.ajax({
                url: '/billing/get-service',
                method: 'GET',
                success: function(data) {
                    populateServicesTable(data);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching services:', xhr.responseText);
                }
            });
        }

        // Function to populate services table
        function populateServicesTable(services) {
            var $tblbody = $('#tblbody');
            $tblbody.empty(); // Clear existing rows

            services.forEach(function(service) {
                var row = `<tr>
                    <td><input class="form-check-input mt-1 td" type="checkbox" <%= result.id ? 'disabled' : '' %>></td>
                    <td>${service.serviceName}</td>
                    <td>${service.className}</td>
                    <td>${service.baseServiceRate}</td>
                </tr>`;
                $tblbody.append(row);
            });
        }

        // Fetch services when the document is ready
        fetchServices();





        // Update the handling of checkboxes for both dynamic and manual entries
        function handleCheckboxChanges(checkbox, isChecked) {
            var row = $(checkbox).closest('tr');
            var serviceName = row.find('td').eq(1).text();
            var className = row.find('td').eq(2).text();
            var serviceRate = row.find('td').eq(3).text();

            

            if (isChecked) {
                var docCategory = $('#docCategory').val();
                var newRow = `<tr>
                    <td contenteditable="true">${serviceName}</td>
                    <td contenteditable="true">${className}</td>
                    <td contenteditable="true">${serviceRate}</td>
                    <td><button class="btn btn-danger btn-sm delete-btn" data-service-name="${serviceName}">Delete</button></td>
                </tr>`;
                $('#selectedServicesTable tbody').append(newRow);
                selectedServices.push({ serviceName, className, serviceRate,docCategory });
                console.log(selectedServices);
            } else {
                $('#selectedServicesTable tbody tr').each(function() {
                    if ($(this).find('td').eq(0).text() === serviceName) {
                        $(this).remove();
                    }
                });
               
                selectedServices = selectedServices.filter(service => service.serviceName !== serviceName);
            }
        }

        $('#tblbody').on('change', 'input[type="checkbox"]', function() {
            handleCheckboxChanges(this, this.checked);
        });

        $('#selectedServicesTable').on('click', '.delete-btn', function() {
            var serviceName = $(this).data('service-name');
            // Uncheck the corresponding checkbox in the "LIST OF SERVICES" table
            $('#tblbody input[type="checkbox"]').each(function() {
                if ($(this).closest('tr').find('td').eq(1).text() === serviceName) {
                    $(this).prop('checked', false);
                }
            });
            // Remove the row from the "LIST OF SELECTED SERVICES" table
            $(this).closest('tr').remove();
            selectedServices = selectedServices.filter(service => service.serviceName !== serviceName);
        });

        $('#selService').on('submit', function(event) {
          
            const { isValid, errorMessage } = validateForm('#selService');
        
           
            event.preventDefault();
            if(isValid){
            $.ajax({
                url: '/billing/selectedService',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(selectedServices),
                success: function(response) {
                    alert('Form submitted successfully!');
                },
                error: function(xhr, status, error) {
                    const response = JSON.parse(xhr.responseText);
                    console.error('Error:', response);
                }
            });
        }else{
            alert(errorMessage);
            $('#errordiv1').removeClass('alert-success').addClass('alert-danger').text(errorMessage).show();
       
        }
        });

        pagi_search('#searchBox', '#servicesTable', '#paginationControls');
    });
</script>


