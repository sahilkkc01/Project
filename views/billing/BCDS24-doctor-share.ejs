<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>LifeLinker</title>
    <%- include('../header'); -%>
        <div class="main-content">

            <div class="row content-top-gap2">
                <div class="col-lg-12">
                    <nav class="navbar navbar-expand-lg navbar-light bg-white">
                        <a class="navbar-brand text-center mr-5" href="#">
                            <span class="dash-icon"><i class="fas fa-tachometer-alt"></i></span>
                            Dashboard
                        </a>
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarNav">
                            <ul class="navbar-nav">
                                <li class="nav-item active text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="far fa-user"></i></span>
                                        Master
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-exchange-alt"></i></span>
                                        Transaction
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-hand-holding-medical"></i></span>
                                        Patient 360
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-receipt"></i></span>
                                        Outside Reciept
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-file-invoice"></i></span>
                                        Outpatient Department
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-chart-line"></i></span>
                                        Analytics
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="far fa-clock"></i></span>
                                        Waiting List
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-wrench"></i></span>
                                        Adminstration
                                    </a>
                                </li>
                                <li class="nav-item text-center">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-spinner"></i></span>
                                        Additional
                                    </a>
                                </li>

                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
            <!-- content -->
            <div class="container-fluid">

                <div class="chart">
                    <div class="row">

                        <div class="col-lg-12 pl-lg-0 mt-2 ml-2">
                            <h4 class="primary">Doctor Share</h4>
                        </div>
                        <div class="col-lg-12 pl-lg-2 chart-grid">
                            <form id="BC-doc-share">
                                <div id="errordiv1"></div>
                                <div class="card card_border">
                                    <div class="">
                                        <!--Past your code here starts-->

                                        <div class="card">
                                            <div class="col-xl-12 p-heading">
                                                <h6 class="p-text">DOCTOR SHARE LIST</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="pl-xl-0">
                                                    <h6 class="primary"></h6>
                                                </div>
                                                <div class="form-row">
                                                    <div class="col-6 mb-1">
                                                        <div class="form-group"><label
                                                                class="input__label">Tariff</label><input name="tariff"
                                                                id="searchBox" type="text"
                                                                class="form-control input-style" placeholder=""></div>
                                                    </div>
                                                </div>





                                                <div class="form-row">
                                                    <div class="col-12 mb-3">
                                                        <div class="form-group">
                                                            <div class="col col-12 pr-xl-0 pl-xl-0">
                                                                <div class="slidx">

                                                                    <table class="table2" id="bcExp">
                                                                        <thead>
                                                                            <tr>
                                                                                <th contenteditable="true">View</th>
                                                                                <th contenteditable="true">Doctor Name
                                                                                </th>
                                                                                <th contenteditable="true">Tariff</th>
                                                                                <th contenteditable="true">
                                                                                    Specialization</th>
                                                                                <th contenteditable="true">
                                                                                    Sub-Specialization</th>
                                                                                <th contenteditable="true">
                                                                                    Status</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody id="exp-table">

                                                                            <!-- <tr>

                                                                                <td colspan="5"
                                                                                    class="text-left px-3 py-2">
                                                                                    Doctor Name: Jyoothi C (1 Item) <br>
                                                                                    Specialization Name Andrology
                                                                                    /Embryology (1 tem) <br>
                                                                                    Tariff Name:F9F(Item)
                                                                                </td>

                                                                            </tr> -->
                                                                            <!-- <tr>
                                                                                <td contenteditable="true"></td>
                                                                                <td contenteditable="true">Jyoothi C</td>
                                                                                <td contenteditable="true">F9F</td>
                                                                                <td contenteditable="true">Andrology</td>
                                                                                <td contenteditable="true"></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td contenteditable="true"></td>
                                                                                <td contenteditable="true"></td>
                                                                                <td contenteditable="true"></td>
                                                                                <td contenteditable="true"></td>
                                                                                <td contenteditable="true"></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td contenteditable="true"></td>
                                                                                <td contenteditable="true"></td>
                                                                                <td contenteditable="true"></td>
                                                                                <td contenteditable="true"></td>
                                                                                <td contenteditable="true"></td>
                                                                            </tr> -->

                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                                <div id="paginationControls"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                            <div id="loadingIndicator"></div>
                                        </div>

                                        <!--Past your code here ends-->
                                    </div>
                                </div>
                                <div class="form-group mt-1 mb-3 text-right">

                                    <button type="button" class="btn-success btn-style btn mt-3 mr-2"
                                        disabled><strong><i class="fa-regular fa-pen-to-square"></i>
                                            Modify</strong></button>

                                    <button type="button" class="btn-secondary btn-style btn mt-3 mr-2"
                                        onclick="window.location.href='/billing/23'"><strong><i
                                                class="fa-solid fa-plus"></i> New</strong></button>

                                    <button type="button" class="btn-danger btn-style btn mt-3 mr-2" disabled><strong><i
                                                class="fas fa-times"></i> Cancel</strong></button>

                                    <button type="button" class="btn-primary btn-style btn mt-3" disabled><strong><i
                                                class="far fa-save"></i> Save</strong></button>
                                </div>
                            </form>
                        </div>
                        <!-- Bootstrap Core JavaScript -->
                        <%- include('../footer'); -%>

                            <div class="modal" id="myModal">
                                <div class="modal-dialog  modal-lg">
                                    <div class="modal-content">

                                        <!-- Modal Header -->
                                        <div class="modal-header">
                                            <a href="#" class="btn-close" id="closebtn" data-bs-dismiss="modal"><i
                                                    class="fa-solid fa-circle-xmark"></i></a>
                                        </div>

                                        <!-- Modal body -->
                                        <div class="modal-body modal-xl">
                                            <div class="chart">
                                                <div class="row">

                                                    <div class="col-lg-12 pl-lg-2 chart-grid mt-3">
                                                        <!--part 1-->
                                                        <h6 class="primary mb-2">Doctor Share Details</h6>
                                                        <div class="card card_border">
                                                            <div class="">
                                                                <div class="col-xl-12 mb-4">
                                                                    <form id="DocShares" method="post" class="mt-2">
                                                                        <div class="row">

                                                                            <div class="col-xl-4 pr-xl-2">
                                                                                <div class="form-group">
                                                                                    <label for="sericeName"
                                                                                        class="input__label">Service
                                                                                        Name</label>
                                                                                    <input type="text"
                                                                                        class="form-control input-style"
                                                                                        id="serviceName"
                                                                                        aria-describedby="emailHelp"
                                                                                        placeholder="">
                                                                                </div>
                                                                            </div>

                                                                           
                                                                        </div>
                                                                        <div class="col-xl-12 mt-3">

                                                                            <div class="row">
                                                                                <h6 class="primary pl-xl-0">List of
                                                                                    Services</h6>
                                                                                <style>
                                                                                    .table-header {
                                                                                        background-color: #f8f9fa;
                                                                                        font-weight: bold;
                                                                                    }

                                                                                    .table-row {
                                                                                        border-top: 1px solid #dee2e6;
                                                                                        padding: 8px 0;
                                                                                    }
                                                                                </style>

                                                                                <!-- <div class="col-xl-12">
                                                                                    <div class="row table-header">

                                                                                        <div class="col-md-2">Service
                                                                                            Name</div>
                                                                                        <div class="col-md-2">Service
                                                                                            Rate</div>
                                                                                        <div class="col-md-2">Share
                                                                                            Amount</div>
                                                                                        <div class="col-md-2">Share
                                                                                            Percentage</div>
                                                                                        <div class="col-md-2">
                                                                                            SubSpecialization</div>
                                                                                    </div>
                                                                                    
                                                                                </div> -->


                                                                                <table class="table2 text-left" id="shares">
                                                                                    <thead class="table-header">
                                                                                        <th class="col-md-2">Service Name</th>
                                                                                        <th class="col-md-2">Service Rate</th>
                                                                                        <th class="col-md-2">Service Amount</th>
                                                                                        <th class="col-md-2">Share
                                                                                            Percentage</th>        
                                                                                            <th class="col-md-2">
                                                                                                SubSpecialization</th>

                                                                                    </thead>
                                                                                    <!-- <tr>
                                          <td></td>
                                          <td>Anti HBE</td>
                                          <td>600.00</td>
                                          <td><input type="text" class="form-control input-style" id="exampleInputEmail1" /></td>
                                          <td>10.00</td>
                                          <td>Clinical labrotary</td>
                                          </tr> -->
                                                                                    <tbody id="services">

                                                                                    </tbody>

                                                                                </table>
                                                                                <div id="paginationControls"></div>

                                                                    </form>

                                                                </div>

                                                            </div>
                                                            <!--part 1 ended-->

                                                            <div class="text-right col-lg-12">
                                                                <div class="text-right col-lg-12">
                                                                    <button type="button" id="addServicesButton" class="btn btn-primary btn-style mt-2 mr-2"><strong>Add</strong></button>
                                                                    <button type="button" class="btn btn-primary btn-style mt-2 mr-2" data-bs-dismiss="modal"><strong>Cancel</strong></button>
                                                                </div>
                                                                
                                                            </div>

                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>

                                    </div>
                                </div>
                                  
                            </div>
                    </div>
                </div>
            </div>

            <script src="../javascripts/statusUpdate.js"></script>
            <script src="../javascripts/pageUpdate.js"></script>

            <script>

                function ChangeStatus3(b) {
               
                    let url = '/billing/change-doc-status'
                    updateStatus(b, url)
                }

                function updateExp(id) {

                    // console.log(id);
                    let url = '/billing/update-exp-master'
                    updatePage(id, url)
                }
            </script>
          <script>
            function attachViewEventListeners() {
                // Use delegation to handle clicks on dynamically added buttons
                $(document).on('click', '.view-button', function() {
                    const subSpecs = JSON.parse($(this).attr('data-subspecs'));
                    console.log(subSpecs)
                    const doctorName = $(this).closest('tr').find('.doctorName').text(); // Fetch the doctor name from the same row
                    alert(doctorName)
                    $('#myModal').data('doctorName', doctorName); // Save the doctor name to the modal
                    fetchServices(subSpecs);
                });
            }
        
            function fetchServices(subSpecs) {
    $.ajax({
        url: '/billing/get-service',
        type: 'GET',
        success: function (services) {
            const subSpecDescs = subSpecs.flatMap(spec => spec.subSpecDesc); // Use flatMap to handle arrays of descriptions
            const filteredServices = services.filter(service => subSpecDescs.includes(service.subSpecialization));

            console.log("Descriptions:", subSpecDescs); // Debug: Log descriptions
            console.log("Filtered Services:", filteredServices); // Debug: Log filtered services

            if (filteredServices.length === 0) {
                console.log("No services match the provided sub-specializations.");
            }

            displayServices(filteredServices, subSpecs);
        },
        error: function (xhr, status, error) {
            console.error('Error fetching services:', error);
        }
    });
}

        
function displayServices(services, subSpecs) {
    let htmlContent = '';
    if (services.length > 0) {
        services.forEach(service => {
            const matchingSubSpecs = subSpecs.filter(spec => spec.subSpecDesc.includes(service.subSpecialization));
            if (matchingSubSpecs.length > 0) {
                matchingSubSpecs.forEach(subSpec => {
                    const sharePercentage = subSpec.share || 0;
                    const discountedRate = calculateDiscount(service.baseServiceRate, sharePercentage);

                    htmlContent += `
                        <tr>
                            <td class="col-md-2">${service.serviceName}</td>
                            <td>${service.baseServiceRate}</td>
                            <td><input type="text" class="form-control input-style" value="${discountedRate.toFixed(2)}" /></td>
                            <td>${sharePercentage}%</td>
                            <td>${service.subSpecialization}</td>
                        </tr>
                    `;
                });
            } else {
                console.log("No matching sub-specializations found for service:", service.serviceName);
            }
        });
    } else {
        htmlContent = '<tr><td colspan="5">No services available or matched your filters.</td></tr>';
    }
    $("#services").html(htmlContent);
}

        
            function calculateDiscount(rate, percentage) {
                return (rate * (percentage / 100));
            }
        </script>
        

            <script type="module">
                import { pagi_search } from '../javascripts/pagi_search.js';

                // console.log(statusUpdate);
                $(document).ready(function () {

                    // Function to fetch and display data
                    function fetchData() {
                        $.ajax({
                            url: '/billing/get-doc',
                            type: 'GET',
                            success: function (data) {
                                data.reverse();
                                let tableRows = '';
                                data.forEach(function (item) {
                                    console.log(JSON.stringify(item.subSpecs));
                                    tableRows += `
                    <tr>
                        <td><button type="button" class="btn btn-primary btn-style btn-change view-button"
    data-bs-toggle="modal" data-bs-target="#myModal" data-subspecs='${JSON.stringify(item.subSpecs)}'>
    View
</button></td>
                        <td class="doctorName">${item.name}</td>
                        <td>${item.tariff}</td>
                        <td>${item.spec}</td>
                        <td>${item.subSpec}</td>
                        <td><input class="form-check-input mt-0" type="checkbox" id='${item.id}' ${item.status ? 'checked' : ''}></td>
                    </tr>
                `;
                                });
                                $('#exp-table').html(tableRows);
                                pagi_search('#searchBox', '#bcExp', '#paginationControls');
                                pagi_search('#searchBox2', '#bcExp', '#paginationControls');
                                pagi_search('#serviceName', '#shares', '#paginationControls');

                                attachViewEventListeners();  // Attach event listeners after the table is populated
                            },
                            error: function (xhr, status, error) {
                                console.error('Error fetching classification details:', error);
                            }
                        });
                    }

                    fetchData();

                    attachViewEventListeners();
                   

                    $('#addServicesButton').click(function() {
            const services = [];
            const doctorName = $('#myModal').data('doctorName'); // Retrieve the doctor name saved in modal data

            $('#services tr').each(function() {
                const serviceName = $(this).find('td').eq(1).text();
                const serviceRate = $(this).find('td').eq(2).text();
                const shareAmount = $(this).find('input').val();
                const sharePercentage = $(this).find('td').eq(4).text().replace('%', '');
                const subSpecialization = $(this).find('td').eq(5).text();

                services.push({
                    serviceName,
                    serviceRate,
                    shareAmount,
                    sharePercentage,
                    subSpecialization
                });
            });

            $.ajax({
                url: '/billing/add-services',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ doctorName, services }),
                success: function(response) {
                    alert('Services added successfully');
                    $('#myModal').modal('hide');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to add services:', error);
                    alert('Failed to add services');
                }
            });
        });
                });
            </script>