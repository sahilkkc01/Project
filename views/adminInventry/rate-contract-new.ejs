<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>LifeLinker</title>
    <%- include('../header'); -%> 
</head>

<body>
    <div class="main-content">
        <div class="row content-top-gap2">
            <div class="col-lg-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-white">
                    <a class="navbar-brand text-center mr-5" href="#">
                        <span class="dash-icon"><i class="fas fa-tachometer-alt"></i></span>
                        Dashboard
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <!-- Add your navigation items here -->
                        </ul>
                    </div>
                </nav>
            </div>
        </div>

        <div class="container-fluid">
            <div class="chart">
                <div class="row">
                    <div class="col-lg-12 pl-lg-2 mt-3 chart-grid">
                        <form id="rateContractForm" method="POST" action="/adminInv/rateContractFormSubmit">
                            <div id="errordiv1"></div>
                            <div class="card card_border">
                                <div class="card">
                                    <div class="col-xl-12 p-heading">
                                        <h6 class="p-text">RATE CONTRACT</h6>
                                    </div>
                                    <div class="form-row pl-lg-3 pr-lg-3 mt-2">
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                            <div class="form-group">
                                                <label class="input__label">Code</label>
                                                <input name="code" type="text" value="<%= result.code %>"
                                                    placeholder="" data-validation="required"
                                                    data-error-message="Code is required."
                                                    class="form-control input-style">
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                            <div class="form-group"><label class="input__label">Description</label>
                                                <input name="description" type="text" class="form-control input-style" value="<%= result.description %>" placeholder="" data-validation="required" data-error-message="Description is required."> 
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                            <div class="form-group"><label class="input__label">Contract Start Date</label>
                                                <input name="contractStartDate" type="date"
                                                data-validation="required"
                                                data-error-message="Contract Start Date is required." class="form-control input-style date-field" value="<%= result.contractStartDate %>">
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                            <div class="form-group"><label class="input__label">Contract End Date</label>
                                                <input name="contractEndDate" type="date"
                                                data-validation="required"
                                                data-error-message="Contract End Date is required." class="form-control input-style date-field" value="<%= result.contractEndDate %>">
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-3">
                                            <div class="form-group"><label class="input__label">Contract Date</label>
                                                <input name="contractDate" type="date"
                                                data-validation="required"
                                                data-error-message="Contract Date is required." class="form-control input-style date-field" value="<%= result.contractDate %>">
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-3">
                                            <div class="form-group"><label class="input__label">Supplier</label>
                                                <select name="supplier"
                                                data-validation="required"
                                                data-error-message="Supplier is required."
                                                class="form-control input-style">
                                                <option value="">Select</option>
                                                <% if (supplier.length > 0) { %>
                                                    <% supplier.forEach(supp => { %>
                                                        <option value="<%= supp.description %>"><%= supp.description %></option>
                                                    <% }) %>
                                                <% } else { %>
                                                    <option>No any Supplier</option>
                                                <% } %>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-3">
                                            <div class="form-group"><label class="input__label">Clinic Representative</label>
                                                <select name="clinicRepresentative"
                                                data-validation="required"
                                                data-error-message="Clinic Representative is required."
                                                class="form-control input-style">
                                                <option value="">Select</option>
                                                <% if (clinic.length > 0) { %>
                                                    <% clinic.forEach(rep => { %>
                                                        <option value="<%= rep.description %>"><%= rep.description %></option>
                                                    <% }) %>
                                                <% } else { %>
                                                    <option>No any Clinic Representative</option>
                                                <% } %>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
                    
                    <!-- Contract List Section -->
                    <div class="mt-1 col-lg-12 pl-lg-2 pr-lg-3">
                        <div class="card card_border">
                            <div class="mb-3">
                                <div class="form-group">
                                    <div class="col-xl-12 p-heading">
                                        <h6 class="p-text">CONTRACT LIST</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-12 mb-3 pl-lg-4 pr-lg-4">
                                    <div class="slidx">
                                        <table class="table2">
                                            <thead>
                                                <tr>
                                                    <th>Item Code</th>
                                                    <th>Item Name</th>
                                                    <th>Manufactured By</th>
                                                    <th>Purchase Quantity</th>
                                                    <th>Transaction UOM</th>
                                                    <th>Purchase Cost Price</th>
                                                    <th>Cost Amount</th>
                                                    <th>M.R.P</th>
                                                    <th>Amount</th>
                                                    <th>Discount %</th>
                                                    <th>Discount Amount</th>
                                                    <th>Net Amount</th>
                                                    <th>HSN Code</th>
                                                    <th>Remarks</th>
                                                    <th>Delete</th>
                                                </tr>
                                            </thead>
                                            <tbody id="contractListBody">
                                                <!-- Rows will be appended here by JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row pl-lg-4 pr-lg-3">
                                <div class="form-group">
                                    <button type="button" class="btn btn-style mt-3 btn-secondary btn-style btn-change"
                                        data-bs-toggle="modal" data-bs-target="#myModal1">
                                        <strong><i class="fa-solid fa-plus"></i> Add Items</strong>
                                    </button>
                                </div>
                                <div class="form-check-label ml-4">
                                    <div class="radio">
                                        <label class="form-check-label mt-3"><input class="form-check-input mt-1"
                                                type="checkbox"> Freeze</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row pl-lg-3 pr-lg-3 mt-2">
                                <div class="col-lg-6 col-md-6 col-sm-12 mb-1">
                                    <div class="form-group">
                                        <label class="input__label">Remark</label>
                                        <input name="remark" type="text" class="form-control input-style"
                                            placeholder="">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12 mb-1">
                                    <div class="form-group"><label class="input__label">Net Amount</label>
                                        <input name="net_amount" readonly id="net_amount" type="number" class="form-control input-style"
                                            placeholder=""
                                            data-validation="required"
                                            data-error-message="Net Amount is required.">
                                    </div>
                                </div>
                            </div>
                            <div id="loadingDiv"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group mt-1 mb-3 text-right">
                    <button type="button" class="btn-success btn-style btn mt-3 mr-2" id="mod-btn"
                        onclick="updateQuery()"><strong><i class="fa-regular fa-pen-to-square"></i> Modify</strong></button>
                    <button type="button" class="btn-secondary btn-style btn mt-3 mr-2" disabled><strong><i
                                class="fa-solid fa-plus"></i> New</strong></button>
                    <a type="button" class="btn-danger btn-style btn mt-3 mr-2" href="/adminInv/44"><strong><i
                                class="fas fa-times" id="submitCancel"></i> Cancel</strong></a>
                    <button type="submit" class="btn-primary btn-style btn mt-3" id="sub-btn"><strong><i
                                class="far fa-save"></i> Save</strong></button>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div class="modal" id="myModal1" data-bs-dismiss="modal">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <a href="#" class="btn-close" data-bs-dismiss="modal"><i class="fa-solid fa-circle-xmark"></i></a>
                </div>
                <!-- Modal body -->
                <div class="modal-body">
                    <form>
                        <div class="card card_border">
                            <div class="card">
                                <div class="form-row pl-lg-3 pr-lg-3 mt-2 mb-3">
                                    <div class="col-lg-3 col-md-6 col-sm-12 mb-2">
                                        <div class="form-group"><label class="input__label">Item Name</label><input
                                                name="description" type="text" id="searchBox"
                                                class="form-control input-style" placeholder=""></div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-12 mb-2">
                                        <div class="form-group"><label class="input__label">Brand Name</label><input
                                                name="description" type="text" id="searchBox"
                                                class="form-control input-style" placeholder=""></div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-12 mb-2">
                                        <div class="form-group"><label class="input__label">Item Code</label><input
                                                name="description" type="text" id="searchBox"
                                                class="form-control input-style" placeholder=""></div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-12 mb-2">
                                        <div class="form-group"><label class="input__label">Item Category</label><select
                                                name="report_generated_by" class="form-control input-style">
                                                <option>Select</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-12 mb-2">
                                        <div class="form-group"><label class="input__label">Item Group</label><select
                                                name="report_generated_by" class="form-control input-style">
                                                <option>Select</option>
                                            </select></div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-12 mb-2">
                                        <div class="form-group"><label class="input__label">Molecule</label><select
                                                name="report_generated_by" class="form-control input-style">
                                                <option>Select</option>
                                            </select></div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-12 mb-2">
                                        <div class="form-group"><label class="input__label">Manufactured By</label><select
                                                name="report_generated_by" class="form-control input-style">
                                                <option>Select</option>
                                            </select></div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-12 mb-2">
                                        <div class="form-group"><button type="button"
                                                class="btn btn-style mt-4 btn-primary btn-style btn-change"><strong><i
                                                    class="fas fa-search"></i>
                                                Search</strong></button></div>
                                    </div>
                                </div>
                                <div class="form-row pl-lg-3 pr-lg-3 mb-3">
                                    <div class="col-lg-12 col-md-12 col-sm-12">
                                        <div class="form-group">
                                            <div class="col col-12 pr-xl-0 pl-xl-0">
                                                <div class="slidx">
                                                    <table class="table2" id="addItemTable">
                                                        <thead>
                                                            <tr>
                                                                <th contenteditable="true" width="15%">Select</th>
                                                                <th contenteditable="true">Item Code</th>
                                                                <th contenteditable="true">Item name</th>
                                                                <th contenteditable="true">Item Category</th>
                                                                <th contenteditable="true">Manufactured By</th>
                                                                <th contenteditable="true">Item Group</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="addItemBody">
                                                            <!-- Rows will be populated here by JavaScript -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div id="paginationControls"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mt-1 mb-3 text-right">
                            <button type="button" class="btn-danger btn-style btn mt-3 mr-2" data-bs-dismiss="modal">
                                <strong><i class="fas fa-times"></i> Cancel</strong></button>
                            <button type="button" class="btn-primary btn-style btn mt-3" id="addSelectedItems"><strong>Ok</strong></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Footer section start -->
    <%- include('../footer'); -%>
    <script src="../javascripts/updateStatus.js"></script>
    <script type="module">
        import { validateForm } from '../javascripts/validation.js';
        import { myAjax } from '../javascripts/myAjax.js';
        import { validateConDate } from '../javascripts/lengthVal.js';
        import { pagi_search } from '../javascripts/pagi_search.js';
        import { dateVal} from '../javascripts/lengthVal.js';
           
            dateVal();
        document.addEventListener('DOMContentLoaded', function() {
    // Function to fetch data and populate modal
    function fetchData() {
        $.ajax({
            url: '/adminInv/get-item-cat-list',
            type: 'GET',
            success: function(data) {
                let dataList = data.result;
                let tableRows = dataList.map(item => `
                    <tr>
                        <td><input type="checkbox" class="item-checkbox" data-item='${JSON.stringify(item)}'></td>
                        <td>${item.item_code}</td>
                        <td>${item.item_name}</td>
                        <td>${item.item_category}</td>
                        <td>${item.manufactured_by}</td>
                        <td>${item.item_group}</td>
                    </tr>
                `).join('');
                $('#addItemBody').html(tableRows);
                pagi_search('#searchBox', '#addItemTable', '#paginationControls');
            },
            error: function(xhr, status, error) {
                console.error('Error fetching classification details:', error);
            }
        });
    }

    fetchData();

    // Add selected items to contract list
    document.getElementById('addSelectedItems').addEventListener('click', function() {
        const selectedItems = document.querySelectorAll('.item-checkbox:checked');
        const contractListBody = document.getElementById('contractListBody');

        selectedItems.forEach(item => {
            const itemData = JSON.parse(item.getAttribute('data-item'));
            const newRow = `
                <tr>
                    <td><input type="hidden" name="item_code[]" value="${itemData.item_code}">${itemData.item_code}</td>
                    <td><input type="hidden" name="item_name[]" value="${itemData.item_name}">${itemData.item_name}</td>
                    <td><input type="hidden" name="manufactured_by[]" value="${itemData.manufactured_by}">${itemData.manufactured_by}</td>
                    <td><input type="number" name="purchase_quantity[]" class="form-control input-style" value="" oninput="calculateAmounts(this)"></td>
                    <td><input type="hidden" name="transaction_uom[]" value="${itemData.purchase_uom}">${itemData.purchase_uom}</td>
                    <td><input type="number" name="purchase_cost_price[]" class="form-control input-style" value="" oninput="calculateAmounts(this)"></td>
                    <td><input type="number" name="cost_amount[]" class="form-control input-style" value="" readonly></td>
                    <td><input type="hidden" name="mrp[]" value="${itemData.base_unit_mrp}">${itemData.base_unit_mrp}</td>
                    <td><input type="number" name="amount[]" class="form-control input-style" value="" readonly></td>
                    <td><input type="number" name="discount_percent[]" class="form-control input-style" value="" oninput="validateDiscountPercent(this)"></td>
                    <td><input type="number" name="discount_amount[]" class="form-control input-style" value="" readonly></td>
                    <td><input type="number" name="net_amount_item[]" class="form-control input-style" value="" readonly></td>
                    <td><input type="hidden" name="hsn_code[]" value="${itemData.hsn_codes}">${itemData.hsn_codes}</td>
                    <td><input type="text" name="remarks_item[]" class="form-control input-style" value=""></td>
                    <td><i class="fas fa-trash-can" style="color: red;" onclick="deleteRow(this)"></i></td>
                </tr>
            `;
            contractListBody.insertAdjacentHTML('beforeend', newRow);
        });

        // Close the modal
        $('#myModal1').modal('hide');
    });

    // Delete row function
    window.deleteRow = function(element) {
        element.closest('tr').remove();
        calculateTotalNetAmount();
    };

    // Calculate cost_amount and amount
    window.calculateAmounts = function(element) {
        const row = element.closest('tr');
        const purchase_quantity = parseFloat(row.querySelector('input[name="purchase_quantity[]"]').value) || 0;
        const purchase_cost_price = parseFloat(row.querySelector('input[name="purchase_cost_price[]"]').value) || 0;
        const mrp = parseFloat(row.querySelector('input[name="mrp[]"]').value) || 0;

        const cost_amount = purchase_quantity * purchase_cost_price;
        const amount = purchase_quantity * mrp;

        row.querySelector('input[name="cost_amount[]"]').value = cost_amount.toFixed(2);
        row.querySelector('input[name="amount[]"]').value = amount.toFixed(2);

        calculateDiscountAmount(row.querySelector('input[name="discount_percent[]"]'));
    };

    // Validate discount percent and calculate discount_amount and net_amount_item
    window.validateDiscountPercent = function(element) {
        if (parseFloat(element.value) > 100) {
            element.value = 100;
        }
        calculateDiscountAmount(element);
    };

    // Calculate discount_amount and net_amount_item
    window.calculateDiscountAmount = function(element) {
        const row = element.closest('tr');
        const amount = parseFloat(row.querySelector('input[name="amount[]"]').value) || 0;
        const discount_percent = parseFloat(element.value) || 0;

        const discount_amount = (amount * discount_percent) / 100;
        row.querySelector('input[name="discount_amount[]"]').value = discount_amount.toFixed(2);

        const net_amount_item = amount - discount_amount;
        row.querySelector('input[name="net_amount_item[]"]').value = net_amount_item.toFixed(2);

        calculateTotalNetAmount();
    };

    // Calculate total net amount
    window.calculateTotalNetAmount = function() {
        let totalNetAmount = 0;
        document.querySelectorAll('input[name="net_amount_item[]"]').forEach(input => {
            totalNetAmount += parseFloat(input.value) || 0;
        });
        document.getElementById('net_amount').value = totalNetAmount.toFixed(2);
    };

    // Submit form with contract list data
    document.getElementById('rateContractForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const mainFormData = $(this).serializeArray();
        let formData = {};
        mainFormData.forEach(field => {
            formData[field.name] = field.value;
        });

        const contractItems = Array.from(document.querySelectorAll('#contractListBody tr')).map((row, index) => {
            return {
                item_code: row.querySelector('input[name="item_code[]"]').value,
                item_name: row.querySelector('input[name="item_name[]"]').value,
                manufactured_by: row.querySelector('input[name="manufactured_by[]"]').value,
                purchase_quantity: row.querySelector('input[name="purchase_quantity[]"]').value,
                transaction_uom: row.querySelector('input[name="transaction_uom[]"]').value,
                purchase_cost_price: row.querySelector('input[name="purchase_cost_price[]"]').value,
                cost_amount: row.querySelector('input[name="cost_amount[]"]').value,
                mrp: row.querySelector('input[name="mrp[]"]').value,
                amount: row.querySelector('input[name="amount[]"]').value,
                discount_percent: row.querySelector('input[name="discount_percent[]"]').value,
                discount_amount: row.querySelector('input[name="discount_amount[]"]').value,
                net_amount_item: row.querySelector('input[name="net_amount_item[]"]').value,
                hsn_code: row.querySelector('input[name="hsn_code[]"]').value,
                remarks_item: row.querySelector('input[name="remarks_item[]"]').value,
            };
        });

        formData.contractItems = contractItems;
        const {isValid, errorMessage} = validateForm('#rateContractForm');

        if (isValid) {
            axios.post('/adminInv/rateContractFormSubmit', formData)
                .then(response => {
                    console.log('Data saved successfully:', response.data);
                    $('#errordiv1').removeClass('alert-danger').addClass('alert-success').text('Rate Contract Saved Succesully').show();
                    alert('Data saved successfully');
                })
                .catch(error => {
                    console.error('Error saving data:', error);
                    alert('Error saving data');
                });
        } else {
            $('#errordiv1').removeClass('alert-success').addClass('alert-danger').text(errorMessage).show();
        }
    });

    // Function to reset forms
    const resetForms = () => {
        $('#rateContractForm')[0].reset();
        $('#errordiv1').hide();
    };
});
</script>
</body>

</html>
