<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>LifeLinkr</title>
    <%- include('../header'); -%>
</head>

<body>
    <!-- main content start -->
    <div class="main-content">
        <div class="row content-top-gap2">
            <div class="col-lg-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-white">
                    <a class="navbar-brand text-center mr-5" href="#">
                        <span class="dash-icon"><i class="fas fa-tachometer-alt"></i></span>
                        Dashboard
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item active text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="far fa-user"></i></span>
                                    Master
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-exchange-alt"></i></span>
                                    Transaction
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-hand-holding-medical"></i></span>
                                    Patient 360
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-receipt"></i></span>
                                    Outside Receipt
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-file-invoice"></i></span>
                                    Outpatient Department
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-chart-line"></i></span>
                                    Analytics
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="far fa-clock"></i></span>
                                    Waiting List
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-wrench"></i></span>
                                    Administration
                                </a>
                            </li>
                            <li class="nav-item text-center">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-spinner"></i></span>
                                    Additional
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
        <!-- content -->
        <div class="container-fluid">
            <div class="chart">
                <div class="row">
                    <div class="col-lg-12 pl-lg-0 mt-2 ml-2">
                        <h4 class="primary">Purchase Requisition</h4>
                    </div>
                    <div class="col-lg-12 pl-lg-2 chart-grid">
                        <div id="errordiv1"></div>
                        <form id="requisitionForm">
                            <input type="hidden" id="requisitionId" value="<%= id %>">
                            <div class="card card_border">
                                <div class="">
                                    <!--Past your code here starts-->
                                    <div class="card">
                                        <div class="card-body pb-3 pt-1">
                                            <div class="pl-lg-0 pr-lg-0 mt-2">
                                                <h6 class="primary">PURCHASE REQUISITION DETAILS</h6>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group"><label class="input__label">Purchase Requisition
                                                            No.</label><input name="requisition_no" id="requisition_no" readonly type="text"
                                                            class="form-control input-style" placeholder=""></div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group"><label class="input__label">Purchase Requisition
                                                            Date</label><input name="requisition_date" id="requisition_date" type="date"
                                                            class="form-control input-style" placeholder=""></div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group"><label class="input__label">Due
                                                            Date</label><input name="due_date" id="due_date" type="date" data-validation="required"
                                                            data-error-message="Due Date is required." class="form-control input-style" placeholder=""></div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group"><label class="input__label">Clinic
                                                            </label><select name="clinic" id="clinic"
                                                            data-validation="required"
                                                            data-error-message="Clinic is required."
                                                            class="form-control input-style">
                                                            <option value="">Select</option>
                                                        </select></div>
                                                </div>
                                            </div>
                                            <div class="pl-lg-0 pr-lg-0">
                                                <h6 class="primary">STORE</h6>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                    <div class="form-group"><label class="input__label">From
                                                            Store</label><select name="from_store" id="from_store" data-validation="required"
                                                            data-error-message="From Store is required." class="form-control input-style">
                                                            <option value="">Select</option>
                                                        </select></div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                    <div class="form-group"><label class="input__label">To
                                                            Store</label><select name="to_store" id="to_store" data-validation="required"
                                                            data-error-message="To Store is required." class="form-control input-style">
                                                            <option value="">Select</option>
                                                        </select></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--Past your code here ends-->
                                </div>
                            </div>
                            <div class="mt-1 col-lg-12 pl-lg-0 pr-lg-0 mt-3">
                                <div class="card card_border">
                                    <div class="form-row">
                                        <div class="col-12 mb-3 mt-3 pl-lg-4 pr-lg-4">
                                            <div class="slidx">
                                                <table id="main-table" class="table2">
                                                    <thead>
                                                        <tr>
                                                            <th>Item Name</th>
                                                            <th>PR Quantity</th>
                                                            <th>UOM</th>
                                                            <th>Delete</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="main-table-body">
                                                        <!-- Rows will be inserted here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="form-check-label text-right">
                                                <button type="button" id="addItems" class="btn-secondary btn-style btn btn-change"
                                                    data-toggle="modal" data-target="#itemSearchModal"><strong><i
                                                        class="fa-solid fa-plus"></i> Add Items</strong></button>
                                            </div>
                                            <div class="radio mt-2 mb-2">
                                                <label class="form-check-label pt-1" style="color: red; font-weight: bold;">
                                                    <input class="form-check-input mt-1" type="checkbox" id="freeze" name="freeze" value="true">
                                                    Freeze Purchase Requisition
                                                </label>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-lg-12 col-md-12 col-sm-12 mt-3">
                                                    <div class="form-group">
                                                        <textarea name="remark" id="remark" class="form-control input-style" placeholder="Add Remarks Here."></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mt-1 mb-3 text-right">
                                <button type="button" disabled class="btn-secondary btn-style btn mt-3 mr-2"><strong><i
                                            class="fa-solid fa-print"></i> Print</strong></button>
                                <button type="button" disabled class="btn-success btn-style btn mt-3 mr-2"><strong><i
                                            class="fa-regular fa-pen-to-square"></i> Modify</strong></button>
                                <button type="button" disabled class="btn-secondary btn-style btn mt-3 mr-2"><strong><i
                                            class="fa-solid fa-plus"></i> New</strong></button>
                                <button type="button" onclick=" window.location.href = '/palashinv/11'"  class="btn-danger btn-style btn mt-3 mr-2"><strong><i
                                            class="fas fa-times"></i> Cancel</strong></button>
                                <button id="save-requisition" type="button" class="btn-primary btn-style btn mt-3"><strong><i
                                            class="far fa-save"></i> Save</strong></button>
                            </div>
                        </form>
                    </div>
                  
                    <div class="modal fade" id="itemSearchModal">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">

                                <!-- Modal Header -->
                                <div class="modal-header">
                                    <h4 class="modal-title">Item Search</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;"></button>
                                </div>

                                <!-- Modal body -->
                                <div class="modal-body">
                                    <form>
                                        <div class="card card_border mt-3">
                                            <div class="card">
                                                <div class="col-xl-12 p-heading">
                                                    <h6 class="p-text">ITEM SEARCH</h6>
                                                </div>
                                                <div class="form-row card-body pb-3 pt-2">
                                                    <div class="col-lg-3 col-md-4 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Item Name</label>
                                                            <input name="service name" type="text"
                                                                class="form-control input-style" placeholder="">
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-4 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Brand Name</label>
                                                            <input name="service name" type="text"
                                                                class="form-control input-style" placeholder="">
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-4 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Item Code</label>
                                                            <input name="service name" type="number"
                                                                class="form-control input-style" placeholder="">
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-4 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Item Category</label>
                                                            <select name="report_generated_by"
                                                                    class="form-control input-style">
                                                                <option>Select</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-4 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Item Group</label>
                                                            <select name="report_generated_by"
                                                                    class="form-control input-style">
                                                                <option>Select</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-4 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Molecule</label>
                                                            <select name="report_generated_by"
                                                                    class="form-control input-style">
                                                                <option>Select</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-4 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Store</label>
                                                            <select name="report_generated_by"
                                                                    class="form-control input-style">
                                                                <option>Select</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-4 col-sm-12 text-left">
                                                        <div class="form-group">
                                                            <button type="button"
                                                                    class="btn btn-style mt-4 btn-primary btn-style btn-change">
                                                                <strong><i class="fas fa-search"></i> Search</strong>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card card_border mt-3">
                                            <div class="col-lg-12 col-md-12 col-sm-12">
                                                <div class="form-check-label">
                                                    <div class="radio mt-2 mb-2">
                                                        <label class="form-check-label pt-1">
                                                            <input class="form-check-input mt-1" type="checkbox" id="select-all-items">
                                                            Select All Items
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row card-body pt-1 pb-3">
                                                <div class="col-12 mb-0">
                                                    <div class="form-group">
                                                        <div class="col col-12 pr-xl-0 pl-xl-0">
                                                            <div class="slidx">
                                                                <table class="table2">
                                                                    <thead>
                                                                    <tr>
                                                                        <th contenteditable="true">Select</th>
                                                                        <th contenteditable="true">Item Code</th>
                                                                        <th contenteditable="true">Item Name</th>
                                                                        <th contenteditable="true">Brand Name</th>
                                                                        <th contenteditable="true">CGST</th>
                                                                        <th contenteditable="true">SGST</th>
                                                                        <th contenteditable="true">IGST</th>
                                                                        <th contenteditable="true">Suspend</th>
                                                                        <th contenteditable="true">Available Stock</th>
                                                                        <th contenteditable="true">Stock UOM</th>
                                                                    </tr>
                                                                    </thead>
                                                                    <tbody id="tbodyid">
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group mt-1 mb-3 text-right">
                                            <button type="button" class="btn-danger btn-style btn mt-3 mr-2"
                                                    data-dismiss="modal">
                                                <strong><i class="fas fa-times"></i> Cancel</strong>
                                            </button>
                                            <button type="button" class="btn-primary btn-style btn mt-3"
                                                    data-dismiss="modal" id="addSelectedItemsBtn">
                                                <strong><i class="fas fa-check"></i> OK</strong>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--footer section start-->
                    <%- include('../footer'); -%>

                    <script type="module">
                        import { validateForm } from '../javascripts/validation.js';
                    
                        $(document).ready(function () {
                            const requisitionId = $('#requisitionId').val();
                            if (requisitionId) {
                                fetchRequisitionData(requisitionId);
                            }
                    
                            function fetchRequisitionData(id) {
                                $.ajax({
                                    url: `/palashinv/get-requisition/${id}`,
                                        type: 'GET',
                                        success: function (response) {
                                            populateRequisitionForm(response.requisition);
                                            populateRequisitionItems(response.items);
                                        },
                                        error: function (xhr, status, error) {
                                            console.error('Error fetching requisition data:', error);
                                        }
                                    });
                                }
                        
                                function populateRequisitionForm(requisition) {
                                    console.log(requisition);
                                    $('#requisition_no').val(requisition.requisition_no);
                                    $('#requisition_date').val(requisition.requisition_date.split('T')[0]);
                                    $('#due_date').val(requisition.due_date.split('T')[0]);
                                    $('#from_store').val(requisition.from_store);
                                    $('#to_store').val(requisition.to_store);
                                    $('#remark').val(requisition.remark);
                                    $('#freeze').prop('checked', requisition.freeze);
                                    if(requisition.freeze){
                                        $('#save-requisition').prop('disabled', true);   
                                    }
                                }
                        
                                function populateRequisitionItems(items) {
                                    let tableRows = '';
                                    items.forEach(function (item) {
                                        tableRows += `
                                            <tr>
                                                <td>${item.itemDetails.item_name}</td>
                                                <td><input type="number" class="form-control input-style" name="requisition_quantity" value="${item.requisition_quantity}"></td>
                                                <td>${item.itemDetails.purchase_uom}</td>
                                                <td><button type="button" class="btn btn-danger btn-sm remove-item"><i class="fa-solid fa-trash-can"></i></button></td>
                                            </tr>
                                        `;
                                    });
                                    $('#main-table-body').html(tableRows);
                                }
                        
                                // Load dropdowns
                                const loadDropdown = (url, elementId) => {
                                    fetch(url)
                                        .then(response => response.json())
                                        .then(data => {
                                            const dropdown = document.getElementById(elementId);
                                            data.forEach(item => {
                                                const option = document.createElement('option');
                                                option.value = item.description || item.rank_desc || item.shelf_desc || item.bin_desc || item.clinic_desc || item.tax_desc;
                                                option.textContent = item.description || item.rank_desc || item.shelf_desc || item.bin_desc || item.clinic_desc || item.tax_desc;
                                                dropdown.appendChild(option);
                                            });
                                        })
                                        .catch(error => console.error(`Error fetching ${elementId} details:`, error));
                                };
                                // Load dropdowns
                                loadDropdown('/adminInv/get-store-details', 'from_store');
                                loadDropdown('/adminInv/get-store-details', 'to_store');
                                loadDropdown('/adminInv/get-clinic-details', 'clinic');
                        
                                // Set current date for Requisition Date
                                const today = new Date().toISOString().split('T')[0];
                                document.getElementById('requisition_date').value = today;
                        
                                // Ensure Due Date is greater than today's date
                                document.getElementById('due_date').setAttribute('min', today);
                        
                                // Fetch data in the popup table
                                function fetchData(from_store) {
            $.ajax({
                url: '/palashinv/get-current-item-counts',
                type: 'GET',
                data: { 
                    store: from_store,
                    clinic: '' // Set clinic to blank
                },
                success: function (data) {
                    console.log(data);
                    let tableRows = '';
                    data.data.forEach(function (item) {
                        tableRows += `
                            <tr data-item-id="${item.id}">
                                <td><input class="form-check-input mt-0 item-checkbox" type="checkbox"></td>
                                <td>${item.item_code}</td>
                                <td>${item.item_name}</td>
                                <td>${item.brand_name}</td>
                                <td>${item.CGST.toFixed(2)}%</td>
                                <td>${item.SGST.toFixed(2)}%</td>
                                <td>${item.IGST.toFixed(2)}%</td>
                                <td><input class="form-check-input mt-0 suspend-checkbox" type="checkbox" ${item.suspend ? 'checked' : ''} disabled></td>
                                <td>${item.availableStock}</td>
                                <td>${item.stocking_uom}</td>
                                <td style="display:none;"><input type="hidden" value="${item.purchase_uom}"></td>
                                <td style="display:none;"><input type="hidden" name="item_id" value="${item.id}"></td>
                                <td style="display:none;"><input type="hidden" name="item_code" value="${item.item_code}"></td>
                            </tr>
                        `;
                    });
                    $('#tbodyid').html(tableRows);

                    // Add the select all checkbox functionality
                    $('#select-all-items').on('change', function () {
                        const isChecked = $(this).is(':checked');
                        $('#tbodyid input.item-checkbox').prop('checked', isChecked);
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching item details:', error);
                }
            });
        }

                                // Add selected items to the main table
                                function addSelectedItems() {
                                    $('#tbodyid input.item-checkbox:checked').each(function () {
                                        const row = $(this).closest('tr');
                                        const itemName = row.find('td:eq(2)').text();
                                        const purchaseUOM = row.find('td:eq(10) input').val();
                                        const itemId = row.find('td:eq(11) input').val();
                        
                                        const newRow = `
                                            <tr>
                                                <td>${itemName}</td>
                                                <td><input type="number" data-validation="required"
                                                        data-error-message="Quantity is required." class="form-control input-style" name="requisition_quantity"></td>
                                                <td>${purchaseUOM}</td>
                                                <td style="display:none;"><input type="hidden" name="item_id" value="${itemId}"></td>
                                                <td><button type="button" class="btn btn-danger btn-sm remove-item"><i class="fa-solid fa-trash-can"></i></button></td>
                                            </tr>
                                        `;
                                        $('#main-table-body').append(newRow);
                                    });
                                }
                        
                                // Fetch data on page load
                                fetchData();
                        
                                // Add event listener to select all items checkbox
                                $('#select-all-items').on('change', function () {
                                    const isChecked = $(this).is(':checked');
                                    $('#popup-table-body input.item-checkbox').prop('checked', isChecked);
                                });
                        
                                $('#addItems').click(function (e) {
            let from_store = $('#from_store').val();

            if (!from_store || from_store === 'Select') {
                alert('Please select From store.');
                e.preventDefault(); // Prevent the default action of opening the modal
                e.stopPropagation(); // Stop the event from bubbling up
                return;
            }

            fetchData(from_store);
        });

                                // Add event listener to add selected items button
                                $('#addSelectedItemsBtn').on('click', addSelectedItems);
                        
                                // Add event listener to remove item button
                                $(document).on('click', '.remove-item', function () {
                                    $(this).closest('tr').remove();
                                });
                        
                                // Event listener for change in from_store and to_store
                                $('#from_store, #to_store').on('change', function() {
                                    const fromStore = $('#from_store').val();
                                    const toStore = $('#to_store').val();
                                    
                                    if (fromStore && toStore && fromStore === toStore) {
                                        alert('From Store and To Store cannot be the same.');
                                        $(this).val(''); // Clear the selected value
                                    }
                                });
                        
                                // Gather and submit the form data
                                $('#save-requisition').on('click', function () {
                                    const requisitionData = {
                                        clinic: $('#clinic').val(),
                                        requisition_no: $('#requisition_no').val(),
                                        requisition_date: $('#requisition_date').val(),
                                        due_date: $('#due_date').val(),
                                        from_store: $('#from_store').val(),
                                        to_store: $('#to_store').val(),
                                        remark: $('#remark').val(),
                                        freeze: $('#freeze').is(':checked'),
                                        items: []
                                    };

                                  
                        
                                    $('#main-table-body tr').each(function () {
                                        const item = {
                                            item_id: $(this).find('input[name="item_id"]').val(),
                                            requisition_quantity: $(this).find('input[name="requisition_quantity"]').val()
                                        };
                                        requisitionData.items.push(item);
                                    });
                        
                                    if (requisitionData.items.length === 0) {
                                        alert('Please add at least one item.');
                                        return;
                                    }
                        
                                    const { isValid, errorMessage } = validateForm('#requisitionForm');
                                    if (isValid) {
                                        if (requisitionData.from_store === requisitionData.to_store) {
                                            $('#errordiv1').removeClass('alert-success').addClass('alert-danger').text('From Store and To Store cannot be the same.');
                                        } else {
                                            $.ajax({
                                                url: '/palashinv/createrequisition',
                                                type: 'POST',
                                                contentType: 'application/json',
                                                data: JSON.stringify(requisitionData),
                                                success: function (response) {
                                                    $('#requisition_no').val(response.requisition.requisition_no);
                                                    $('#errordiv1').addClass('alert-success').removeClass('alert-danger').text(response.message).show();
                                                    alert(response.message);
                                                },
                                                error: function (xhr, status, error) {
                                                    alert('Something Went Wrong');
                                                    $('#errordiv1').removeClass('alert-success').addClass('alert-danger').text('Something went wrong').show();
                                                    console.error('Error creating requisition:', error);
                                                }
                                            });
                                        }
                                    } else {
                                        $('#errordiv1').removeClass('alert-success').addClass('alert-danger').text(errorMessage);
                                    }
                                });
                            });
                        </script>
                        