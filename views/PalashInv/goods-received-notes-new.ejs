<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>LifeLinkr</title>
    <%-include('../header');-%>
</head>

<body>
    <div class="main-content">
        <div class="row content-top-gap2">
            <div class="col-lg-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-white">
                    <a class="navbar-brand text-center mr-5" href="#">
                        <span class="dash-icon"><i class="fas fa-tachometer-alt"></i></span>
                        Dashboard
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item active text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="far fa-user"></i></span>
                                    Master
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-exchange-alt"></i></span>
                                    Transaction
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-hand-holding-medical"></i></span>
                                    Patient 360
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-receipt"></i></span>
                                    Outside Receipt
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-file-invoice"></i></span>
                                    Outpatient Department
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-chart-line"></i></span>
                                    Analytics
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="far fa-clock"></i></span>
                                    Waiting List
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-wrench"></i></span>
                                    Administration
                                </a>
                            </li>
                            <li class="nav-item text-center">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-spinner"></i></span>
                                    Additional
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>

        <!-- content -->
        <div class="container-fluid">
            <div class="chart">
                <div class="row">
                    <div class="col-lg-12 pl-lg-0 mt-2 ml-2">
                        <h4 class="primary">Goods Received Notes</h4>
                    </div>

                    <div class="col-lg-12 pl-lg-2 chart-grid">
                        <div id="errordiv1"></div>
                        <form id="grnForm" enctype="multipart/form-data">
                            <div class="card card_border">
                                <div class="card-body pb-3 pt-1">
                                    <div class="pl-lg-0 pr-lg-0 pt-2">
                                        <h6 class="primary">GRN DETAILS</h6>
                                    </div>

                                    <div class="form-row">
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group"><label class="input__label">GRN No.</label><input name="grn_no" id="grn_no" type="text" readonly class="form-control input-style" placeholder=""></div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group"><label class="input__label">Date</label><input name="date" id="date" type="date" readonly class="form-control input-style" placeholder=""></div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group"><label class="input__label">Gate Entry No</label><select name="gate_entry_no" id="gate_entry_no" class="form-control input-style">
                                                <option value="">Select</option>
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                            </select></div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group"><label class="input__label">Store</label><select name="store" id="store" class="form-control input-style"><option value="">Select</option></select></div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group"><label class="input__label">Supplier</label><select name="supplier" id="supplier" class="form-control input-style"><option value="">Select</option></select></div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <label class="input__label">Pay Mode</label>
                                            <div class="form-row pl-lg-0">
                                                <div class="radio">
                                                    <label class="form-check-label pt-1"><input class="form-check-input mt-1" type="radio" name="pay_mode" value="GRC"> GRC</label>
                                                </div>
                                                <div class="radio ">
                                                    <label class="form-check-label pt-1"><input class="form-check-input mt-1" type="radio" name="pay_mode" value="Credit"> Credit</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pl-lg-0 pr-lg-0 mt-2">
                                        <h6 class="primary">INVOICE DETAILS</h6>
                                    </div>

                                    <div class="form-row">
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group"><label class="input__label">Invoice Date</label><input name="invoice_date" id="invoice_date" type="date" class="form-control input-style" placeholder=""></div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group"><label class="input__label">Invoice No.</label><input name="invoice_no" id="invoice_no" type="text" class="form-control input-style" placeholder=""></div>
                                        </div>
                                        
                                        <div class="col-lg-3 col-md-4 col-sm-12">
                                            <div class="form-group"><button type="button" class="btn btn-style mt-4 btn-secondary btn-style btn-change"><strong><i class="fa-solid fa-paperclip"></i> Attach Invoice</strong></button></div>
                                        </div>
                                    </div>

                                    <div class="pl-lg-0 pr-lg-0 mt-2">
                                        <h6 class="primary">GET ITEMS</h6>
                                    </div>

                                    <div class="form-row">
                                        <div class="col-lg-6 col-md-4 col-sm-12">
                                            <div class="form-check-label form-row">
                                                <div class="radio ">
                                                    <label class="form-check-label pt-1 pr-4"><input class="form-check-input mt-1" type="radio" name="item_mode" value="Direct Purchase"> Direct Purchase</label>
                                                    <label class="form-check-label pt-1 pl-4"><input class="form-check-input mt-1" type="radio" name="item_mode" value="Against Purchase"> Against Purchase Order</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-12">
                                            <div class="form-group row">
                                                <div class="col-md-2">
                                                    <button type="button" id="getItems" class="btn btn-style mt-2 btn-primary btn-change" data-toggle="modal" data-target="#itemSearchModal">
                                                        <strong>Get Items</strong>
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button type="button" id="getPO" class="btn btn-style mt-2 btn-primary btn-change" data-toggle="modal" data-target="#poSearchModal">
                                                        <strong>Get PO</strong>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        

                                    </div>
                                </div>
                            </div>

                            <div class="mt-1 col-lg-12 pl-lg-0 pr-lg-0 mt-3">
                                <div class="card card_border">
                                    <div class="mb-2">
                                        <div class="form-group">
                                            <div class="col-xl-12 p-heading">
                                                <h6 class="p-text">MAIN ITEMS</h6>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <div class="col col-12 mb-3 pr-lg-4 pl-lg-4">
                                                    <div class="slidex">
                                                        <table class="table2" id="selectedItemsTable">
                                                            <thead>
                                                                <tr>
                                                                    <th style="min-width: 100px;">Item Name</th>
                                                                    <th style="min-width: 100px;">Batch Code</th>
                                                                    <th>Expiry Date</th>
                                                                    <th style="min-width: 100px;">Bar Code</th>
                                                                    <th style="min-width: 100px;">UOM</th>
                                                                    <th style="min-width: 100px;">Received Quantity</th>
                                                                    <th style="min-width: 100px;">UOM</th>
                                                                    <th style="min-width: 100px;">S.UOM</th>
                                                                    <th style="min-width: 100px;">Conversion Factor</th>
                                                                    <th style="min-width: 100px;">Total Quantity</th>
                                                                    <th style="min-width: 100px;">Available Stock</th>
                                                                    <th style="min-width: 100px;">Cost Price</th>
                                                                    <th style="min-width: 100px;">Cost Amount</th>
                                                                    <th style="min-width: 100px;">Average Cost</th>
                                                                    <th style="min-width: 100px;">Average Cost Amount</th>
                                                                    <th style="min-width: 100px;">MRP</th>
                                                                    <th style="min-width: 100px;">Abated MRP</th>
                                                                    <th style="min-width: 100px;">Amount</th>
                                                                    <th style="min-width: 100px;">C.Disc %</th>
                                                                    <th style="min-width: 100px;">C.Disc. Amount</th>
                                                                    <th style="min-width: 100px;"> Sch. Disc. %</th>
                                                                    <th style="min-width: 100px;">Sch. Disc. Amount</th>
                                                                    <th style="min-width: 100px;">CGST %</th>
                                                                    <th style="min-width: 100px;">CGST Amount</th>
                                                                    <th style="min-width: 100px;">SGST %</th>
                                                                    <th style="min-width: 100px;">SGST Amount</th>
                                                                   
                                                                    <th style="min-width: 100px;">IGST %</th>
                                                                    <th style="min-width: 100px;">IGST Amount</th>
                                                                    <th style="min-width: 100px;">Net Amount</th>
                                                                    <th style="min-width: 100px;">Remarks</th>
                                                                    <th style="min-width: 100px;">Rack</th>
                                                                    <th style="min-width: 100px;">Shelf</th>
                                                                    <th style="min-width: 100px;">Bin</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="maintable">
                                                                <!-- Rows will be inserted here -->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-1 col-lg-12 pl-lg-0 pr-lg-0 mt-3">
                                <div class="card card_border">
                                    <div class="card-body pt-2 pb-2">
                                        <div class="form-row">
                                            <!-- Total Amount -->
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">Total Amount</label>
                                                    <input name="grn_total_amount" id="grn_total_amount" type="number" class="form-control input-style" readonly>
                                                </div>
                                            </div>
                                            <!-- SGST, CGST, and IGST Amounts -->
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">SGST Amount</label>
                                                    <input name="grn_sgst_amount" id="grn_sgst_amount" type="number" class="form-control input-style" readonly>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">CGST Amount</label>
                                                    <input name="grn_cgst_amount" id="grn_cgst_amount" type="number" class="form-control input-style" readonly>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">IGST Amount</label>
                                                    <input name="grn_igst_amount" id="grn_igst_amount" type="number" class="form-control input-style" readonly>
                                                </div>
                                            </div>
                                            <!-- Free Items SGST, CGST, IGST Amounts -->
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">Free Item SGST Amount</label>
                                                    <input name="grn_free_item_sgst_amount" id="grn_free_item_sgst_amount" type="number" class="form-control input-style" readonly>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">Free Item CGST Amount</label>
                                                    <input name="grn_free_item_cgst_amount" id="grn_free_item_cgst_amount" type="number" class="form-control input-style" readonly>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">Free Item IGST Amount</label>
                                                    <input name="grn_free_item_igst_amount" id="grn_free_item_igst_amount" type="number" class="form-control input-style" readonly>
                                                </div>
                                            </div>
                                            <!-- Other Charges and Discounts -->
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">Other Charges</label>
                                                    <input name="grn_other_charges" id="grn_other_charges" type="number" class="form-control input-style">
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">C.Disc. Amount</label>
                                                    <input name="grn_c_disc_amount" id="grn_c_disc_amount" type="number" class="form-control input-style">
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">Sch. Disc. Amount</label>
                                                    <input name="grn_sch_disc_amount" id="grn_sch_disc_amount" type="number" class="form-control input-style">
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">GRN Discount</label>
                                                    <input name="grn_discount" id="grn_discount" type="number" class="form-control input-style">
                                                </div>
                                            </div>
                                            <!-- Net Amounts -->
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div the="form-group">
                                                    <label class="input__label">Round Off Net Amount</label>
                                                    <input name="grn_round_off_net_amount" id="grn_round_off_net_amount" type="number" class="form-control input-style" readonly>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">Net Amount</label>
                                                    <input name="grn_net_amount" id="grn_net_amount" type="number" class="form-control input-style" readonly>
                                                </div>
                                            </div>
                                            <!-- Received By and Remark -->
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label the="input__label">Received By</label>
                                                    <select name="grn_received_by" id="grn_received_by" class="form-control input-style">
                                                        <option value="">Select</option>
                                                        <option value="A">A</option>
                                                        <option value="B">B</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                <div class="form-group">
                                                    <label class="input__label">Remark</label>
                                                    <textarea name="grn_remark" id="grn_remark" class="form-control input-style" placeholder=""></textarea>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-sm-12">
                                                <div class="form-check-label form-row">
                                                    <div class="radio pt-4">
                                                        <label class="form-check-label pt-1 pr-4">
                                                            <input class="form-check-input mt-1" type="checkbox" id="is_finalize" name="is_finalize">Is Finalize
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            

                            <div class="form-group mt-1 mb-3 text-right">
                                <button type="button" disabled class="btn-secondary btn-style btn mt-3 mr-2"><strong><i class="fa-solid fa-print"></i> Print</strong></button>
                                <button type="button" disabled class="btn-secondary btn-style btn mt-3 mr-2"><strong><i class="fa-solid fa-plus"></i> New</strong></button>
                                <button type="button" onclick="window.location.href = '/palashinv/14'" class="btn-danger btn-style btn mt-3 mr-2"><strong><i class="fas fa-times"></i> Cancel</strong></button>
                                <button type="button" class="btn-primary btn-style btn mt-3" id="saveGRNBtn"><strong><i class="far fa-save"></i> Save</strong></button>
                            </div>
                        </form>
                    </div>

                    <!-- The Modal -->
                    <div class="modal fade" id="itemSearchModal">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
            
                                <!-- Modal Header -->
                                <div class="modal-header">
                                    <h4 class="modal-title">Item Search</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;"></button>
                                </div>
            
                                <!-- Modal body -->
                                <div class="modal-body">
                                    <form>
                                        <div class="card card_border mt-3">
                                            <div class="card">
                                                <div class="col-xl-12 p-heading">
                                                    <h6 class="p-text">ITEM SEARCH</h6>
                                                </div>
                                                <div class="form-row card-body pb-3 pt-2">
                                                    <!-- First Row -->
                                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Item Name</label>
                                                            <input name="item_name" id="item_name" type="text" class="form-control input-style" placeholder="">
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Brand Name</label>
                                                            <input name="brand_name" id="brand_name" type="text" class="form-control input-style" placeholder="">
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Item Code</label>
                                                            <input name="item_code" id="item_code" type="text" class="form-control input-style" placeholder="">
                                                        </div>
                                                    </div>
                                                
                                                    <!-- Second Row -->
                                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Item Category</label>
                                                            <select name="item_category" id="item_category" class="form-control input-style">
                                                                <option value="">Select</option>
                                                                <!-- Add category options here -->
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Item Group</label>
                                                            <select name="item_group" id="item_group" class="form-control input-style">
                                                                <option value="">Select</option>
                                                                <!-- Add group options here -->
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Molecule</label>
                                                            <select name="molecule" id="molecule" class="form-control input-style">
                                                                <option value="">Select</option>
                                                                <!-- Add molecule options here -->
                                                            </select>
                                                        </div>
                                                    </div>
                                                
                                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Store</label>
                                                            <select name="store_search" id="store_search" class="form-control input-style">
                                                                <option value="">Select</option>
                                                                <!-- Add molecule options here -->
                                                            </select>
                                                        </div>
                                                    </div>
                                                
                                                    <!-- Search Button -->
                                                    <div class="col-lg-12 text-left">
                                                        <div class="form-group">
                                                            <button type="button" id="searchItemsBtn" class="btn btn-style mt-4 btn-primary btn-change">
                                                                <strong><i class="fas fa-search"></i> Search</strong>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>
                                        <div class="card card_border mt-3">
                                            <div class="col-lg-12 col-md-12 col-sm-12">
                                                <div class="form-check-label">
                                                    <div class="radio mt-2 mb-2">
                                                        <label class="form-check-label pt-1">
                                                            <input class="form-check-input mt-1" type="checkbox" id="select-all-items">
                                                            Select All Items
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="container">
                                                <div class="row">
                                                    <!-- First Div (Existing) -->
                                                    <div class="col-md-6">
                                                        <div class="form-row card-body pt-1 pb-3">
                                                            <div class="col-12 mb-0">
                                                                <div class="form-group">
                                                                    <div class="col col-12 pr-xl-0 pl-xl-0">
                                                                        <div class="slidex">
                                                                            <table class="table2">
                                                                                <thead>
                                                                                    <tr>
                                                                                        <th contenteditable="true">Select</th>
                                                                                        <th contenteditable="true">Item Code</th>
                                                                                        <th contenteditable="true">Item Name</th>
                                                                                        <th contenteditable="true">Brand Name</th>
                                                                                        <th contenteditable="true">CGST</th>
                                                                                        <th contenteditable="true">SGST</th>
                                                                                        <th contenteditable="true">IGST</th>
                                                                                    
                                                                                        
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody id="tbodyid">
                                                                                    <!-- Table rows will be inserted here -->
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                            
                                                    <!-- Second Div (New) -->
                                                    <div class="col-md-6">
                                                        <div class="form-row card-body pt-1 pb-3">
                                                            <div class="col-12 mb-0">
                                                                <div class="form-group">
                                                                    <div class="col col-12 pr-xl-0 pl-xl-0">
                                                                        <div class="slidex">
                                                                            <table class="table2">
                                                                                <thead>
                                                                                    <tr>
                                                                                        <th contenteditable="true">Select</th>
                                                                                        <!-- <th contenteditable="true">Date</th> -->
                                                                                        <th contenteditable="true">Batch Code</th>
                                                                                        <th contenteditable="true">is Free</th>
                                                                                        <th contenteditable="true">Available Quantity</th>
                                                                                        <th contenteditable="true">UOM</th>
                                                                                        <th contenteditable="true">Purchase Rate</th>
                                                                                        <th contenteditable="true">MRP</th>
                                                                                        <th contenteditable="true">Expiry Date</th>
                                                                                      
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody id="tbodyid2">
                                                                                    <!-- Table rows will be inserted here -->
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-12 mb-0">
                                                        <div class="form-group">
                                                            <div class="col col-12 pr-xl-0 pl-xl-0">
                                                                <div class="slidx">
                                                                    <table class="table2">
                                                                        <thead>
                                                                        <tr>
                                                                            <th contenteditable="true"></th>
                                                                            <th contenteditable="true">Item Code</th>
                                                                            <th contenteditable="true">Item Name</th>
                                                                            <th contenteditable="true">Batch Code</th>
                                                                            <th contenteditable="true">Expiry Date</th>
                                                                            <th contenteditable="true">Available Stock</th>
                                                                            <th contenteditable="true">MRP</th>
                                                                            <th contenteditable="true">Cost Price</th>
                                                                            <th contenteditable="true">CGST</th>
                                                                            <th contenteditable="true">SGST</th>
                                                                            <th contenteditable="true">IGST</th>
                                                                           
                                                                        </tr>
                                                                        </thead>
                                                                        <tbody id="tbodyid3">
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div                                                    </div>
                                                    </div>
                                                </div>
                                            </div>
                                                </div>
                                            </div>
                                            
                                        <div class="form-group mt-1 mb-3 text-right">
                                            <button type="button" class="btn-danger btn-style btn mt-3 mr-2"
                                                    data-dismiss="modal">
                                                <strong><i class="fas fa-times"></i> Cancel</strong>
                                            </button>
                                            <button type="button" class="btn-primary btn-style btn mt-3"
                                                    data-dismiss="modal" id="addSelectedItemsBtn">
                                                <strong><i class="fas fa-check"></i> OK</strong>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--footer section start-->
                    <%- include('../footer'); -%>

                    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
                   
                  <script>
                    $(document).ready(function () {

                        $('#date').val(new Date().toISOString().slice(0, 10));
                        const loadDropdown = (url, elementId) => {
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const dropdown = document.getElementById(elementId);
            let items = data;
            if (elementId === 'item_category') {
                items = data.ItemCatData;
            }
            if (elementId === 'item_group'  || elementId === 'molecule') {

                items = data.result;
            }
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.description || item.rank_desc || item.shelf_desc || item.bin_desc || item.clinic_desc || item.tax_desc || item.Item_description;
                option.textContent = item.description || item.rank_desc || item.shelf_desc || item.bin_desc || item.clinic_desc || item.tax_desc || item.Item_description;
                dropdown.appendChild(option);
            });
        })
        .catch(error => console.error(`Error fetching ${elementId} details:`, error));
};

   
    loadDropdown('/adminInv/get-store-details', 'store'); 
    
    loadDropdown('/adminInv/get-supplier-details', 'supplier');
    loadDropdown('/adminInv/getAll-itemCat-list', 'item_category');
    loadDropdown('/adminInv/getAll-itemGroup-list', 'item_group');
    loadDropdown('/adminInv/getAll-molecule-list', 'molecule');
    loadDropdown('/adminInv/get-store-details', 'store_search'); 

})

document.getElementById('searchItemsBtn').addEventListener('click', function() {
    // Collect search parameters
    const searchParams = {
        item_name: document.getElementById('item_name').value || null,
        brand_name: document.getElementById('brand_name').value || null,
        item_code: document.getElementById('item_code').value || null,
        item_category: document.getElementById('item_category').value || null,
        item_group: document.getElementById('item_group').value || null,
        molecule_name: document.getElementById('molecule').value || null,
        store: document.getElementById('store_search').value || null
    };

    // Filter out null values
    const filteredParams = {};
    for (const key in searchParams) {
        if (searchParams[key] !== null && searchParams[key] !== "") {
            filteredParams[key] = searchParams[key];
        }
    }

    // Make the search request using Axios
    axios.get('/palashinv/getItemsOnSearch', { params: filteredParams })
    .then(function(response) {
        console.log(response);
        const data = response.data;
        
        document.getElementById('tbodyid').innerHTML = '';
        let tableRows = '';

        // Populate the search results table
        data.forEach(item => {
            const storeTax = item.storeTaxes && item.storeTaxes.length > 0 ? item.storeTaxes[0] : {};
            
            tableRows += `
                <tr data-item-id="${item.id}" data-purchase-rate="${item.base_unit_cost_price}" data-mrp="${item.base_unit_mrp}" onclick="fetchBatches(this)">
                    <td><input type="checkbox"></td>
                    <td>${item.item_code}</td>
                    <td>${item.item_name}</td>
                    <td>${item.brand_name}</td>
                    <td>${storeTax.CGST !== undefined && storeTax.CGST !== null ? storeTax.CGST : 'N/A'}</td>
                    <td>${storeTax.SGST !== undefined && storeTax.SGST !== null ? storeTax.SGST : 'N/A'}</td>
                    <td>${storeTax.IGST !== undefined && storeTax.IGST !== null ? storeTax.IGST : 'N/A'}</td>
                    <td style="display:none;" mrp>${item.conversionFactors[0].from_uom}</td>
                    <td style="display:none;" mrp>${item.conversionFactors[0].to_uom}</td>
                    <td style="display:none;" mrp>${item.conversionFactors[0].conversion_factor}</td>
                </tr>
            `;
        });

        document.getElementById('tbodyid').innerHTML = tableRows;
    })
    .catch(function(error) {
        console.error('Error fetching search results:', error);
    });

});

function fetchBatches(e){

    const previouslySelected = document.querySelector('.locked');
if (previouslySelected) {
    previouslySelected.classList.remove('locked');
}

// Add 'locked' class to the currently selected row
e.classList.add('locked');

    const itemId = e.getAttribute('data-item-id');
    const purchase_rate = e.getAttribute('data-purchase-rate');
    const mrp = e.getAttribute('data-mrp');
    console.log(purchase_rate)
    console.log(mrp)
     axios.get(`/palashinv/getItemBatches/${itemId}`)
    .then(function(response) {
        console.log(response);
        const data = response.data;
        
        document.getElementById('tbodyid2').innerHTML = '';
        let tableRows = '';

        // Populate the search results table
        data.forEach(item => {
            const storeTax = item.storeTaxes && item.storeTaxes.length > 0 ? item.storeTaxes[0] : {};
            
            tableRows += `
                <tr data-item-id="${item.id}">
                    <td><input type="checkbox"></td>
                    <td>${item.batchCode}</td>
                    <td><input type="checkbox"  data-id='${item.id}' ${item.isFree ? 'checked disabled' : ''}></td>
                    <td>${item.availableStock}</td>
                    <td>${item.uom}</td>
                    <td>${purchase_rate}</td>
                    <td>${mrp}</td>
                    <td>${formatDate(item.expiryDate)}</td>
                    </tr>
            `;
        });

        document.getElementById('tbodyid2').innerHTML = tableRows;
    })
    .catch(function(error) {
        console.error('Error fetching search results:', error);
    });


}


document.addEventListener('click', function(e) {
    if (e.target.matches('#tbodyid2 input[type="checkbox"]')) {
        const checkbox = e.target;
        const selectedBatchRow = checkbox.closest('tr');

        if (checkbox.checked) {
            const selectedItemRow = document.querySelector('#tbodyid .locked');

            if (selectedItemRow) {
                // Get values from tbodyid (selected item row)
                const itemCode = selectedItemRow.children[1].textContent.trim();
                const itemName = selectedItemRow.children[2].textContent.trim();
                const brandName = selectedItemRow.children[3].textContent.trim();
                const cgst = selectedItemRow.children[4].textContent.trim();
                const sgst = selectedItemRow.children[5].textContent.trim();
                const igst = selectedItemRow.children[6].textContent.trim();
                const from_uom = selectedItemRow.children[7].textContent.trim();
                const to_uom = selectedItemRow.children[8].textContent.trim();
                const conv_fact = selectedItemRow.children[9].textContent.trim();
                const purchaseRate = selectedItemRow.getAttribute('data-purchase-rate');
                const mrp = selectedItemRow.getAttribute('data-mrp');

                // Get values from tbodyid2 (selected batch row)
                const batchCode = selectedBatchRow.children[1].textContent.trim();
                const isFree = checkbox.checked;
                const availableStock = selectedBatchRow.children[3].textContent.trim();
                const uom = selectedBatchRow.children[4].textContent.trim();
                const expiryDate = selectedBatchRow.children[7].textContent.trim();

                // Create a new row for tbodyid3
                const newRow = `
                    <tr>
                        <td><input type="checkbox" checked ></td>
                        <td>${itemCode}</td>
                        <td>${itemName}</td>
                        <td>${batchCode}</td>
                        <td>${expiryDate}</td>
                        <td>${availableStock}</td>
                        <td>${mrp}</td>
                        <td>${purchaseRate}</td>
                        <td>${cgst}</td>
                        <td>${sgst}</td>
                        <td>${igst}</td>
                        <td style="display:none;">${uom}</td>
                        <td style="display:none;">${from_uom}</td>
                        <td style="display:none;">${to_uom}</td>
                        <td style="display:none;">${conv_fact}</td>
                    </tr>
                `;

                // Append the new row to tbodyid3
                document.getElementById('tbodyid3').insertAdjacentHTML('beforeend', newRow);
            } else {
                alert("Please select an item first.");
                checkbox.checked = false; // Uncheck the checkbox if no item is selected
            }
        } else {
            // If the checkbox is unchecked, remove the corresponding row from tbodyid3
            const batchCode = selectedBatchRow.children[1].textContent.trim();
            const rows = document.querySelectorAll('#tbodyid3 tr');
            rows.forEach(row => {
                if (row.children[3].textContent.trim() === batchCode) {
                    row.remove();
                }
            });
        }
    }
});


document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('addSelectedItemsBtn').addEventListener('click', function() {
        const selectedRows = document.querySelectorAll('#tbodyid3 input[type="checkbox"]:checked');

        selectedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const itemCode = row.cells[1].textContent.trim();
            const itemName = row.cells[2].textContent.trim();
            const batchCode = row.cells[3].textContent.trim();
            const expiryDate = row.cells[4].textContent.trim();
            const availableStock = row.cells[5].textContent.trim();
            const mrp = row.cells[6].textContent.trim();
            const costPrice = row.cells[7].textContent.trim();
            const cgstPercent = row.cells[8].textContent.trim();
            const sgstPercent = row.cells[9].textContent.trim();
            const igstPercent = row.cells[10].textContent.trim();
            const uom = row.cells[11].textContent.trim();
            const from_uom = row.cells[12].textContent.trim();
            const to_uom = row.cells[13].textContent.trim();
            const conv_fact = row.cells[14].textContent.trim();

            const newRow = `
               <tr  data-original-conversion-factor="${conv_fact}">
    <td><input type="text" class="form-control" name="item_name" value="${itemName}" style="display:none;">${itemName}</td>
    <td><input type="text" class="form-control" name="batch_code" value="${batchCode}"></td>
    <td><input type="date" class="form-control" name="expiry_date" value="${expiryDate}"></td>
    <td><input type="text" class="form-control" name="bar_code"></td>
    <td><input type="text" class="form-control" name="uom" value="${uom}" style="display:none;">${uom}</td>
    <td><input type="number" class="form-control" name="received_quantity"></td>
    <td>
        <select name="uom_select" class="form-control input-style">
                        <option value="${from_uom}">${from_uom}</option>
                        <option value="${to_uom}">${to_uom}</option>
        </select>
    </td>
    <td><input type="text" class="form-control" name="s_uom" value="${to_uom}" style="display:none;">${to_uom}</td>
    <td><input type="number" class="form-control" name="conversion_factor" value="${conv_fact}"></td>
    <td><input type="number" class="form-control" name="total_quantity"></td>
    <td><input type="number" class="form-control" name="available_stock" value="${availableStock}"></td>
    <td><input type="number" class="form-control" name="cost_price" value="${costPrice}"></td>
    <td><input type="number" class="form-control" name="cost_amount" readonly></td>
    <td><input type="number" class="form-control" name="avg_cost"></td>
    <td><input type="number" class="form-control" name="avg_cost_amount" readonly></td>
    <td><input type="number" class="form-control" name="mrp" value="${mrp}"></td>
    <td><input type="number" class="form-control" name="abated_mrp" ></td>
    <td><input type="number" class="form-control" name="amount" readonly></td>
    <td><input type="number" class="form-control" name="c_disc_percent"></td>
    <td><input type="number" class="form-control" name="c_disc_amount"></td>
    <td><input type="number" class="form-control" name="sch_disc_percent"></td>
    <td><input type="number" class="form-control" name="sch_disc_amount"></td>
    <td><input type="number" class="form-control" name="cgst_percent" value="${cgstPercent}"></td>
    <td><input type="number" class="form-control" name="cgst_amount" readonly></td>
    <td><input type="number" class="form-control" name="sgst_percent" value="${sgstPercent}"></td>
    <td><input type="number" class="form-control" name="sgst_amount" readonly></td>
    <td><input type="number" class="form-control" name="igst_percent" value="${igstPercent}"></td>
    <td><input type="number" class="form-control" name="igst_amount" readonly></td>
    <td><input type="number" class="form-control" name="net_amount" readonly></td>
    <td><input type="text" class="form-control" name="remarks"></td>
    <td><input type="text" class="form-control" name="rack"></td>
    <td><input type="text" class="form-control" name="shelf"></td>
    <td><input type="text" class="form-control" name="bin"></td>
    <td><input type="text" class="form-control" name="item_code" value="${itemCode}" style="display:none;"></td>

</tr>

            `;

            document.getElementById('maintable').insertAdjacentHTML('beforeend', newRow);
            checkbox.checked = false; // Optionally uncheck after adding
            // updateCalculation(); // Call a function to update calculations if necessary
        });
    });
});  

    
$(document).ready(function() {
    // This function performs calculations dynamically and updates totals
    function updateCalculations() {
        
        console.log("Updating calculations...");
        let totalNetAmount = 0;
        let totalCgstAmount = 0;
        let totalSgstAmount = 0;
        let totalIgstAmount = 0;
        let totalOtherCharges = parseFloat($('#grn_other_charges').val()) || 0; // Get other charges
        let totalCDiscAmount = 0;  // Initialize total commercial discount amount
        let totalSchDiscAmount = 0; // Initialize total scheduled discount amount
        let totalGrnDiscount = parseFloat($('#grn_discount').val()) || 0; // Get manually entered GRN discount

        $('#maintable tr').each(function() {
            const row = $(this);
            const receivedQuantity = parseFloat(row.find('[name="received_quantity"]').val()) || 0;
            const costPrice = parseFloat(row.find('[name="cost_price"]').val()) || 0;
            const avgCost = parseFloat(row.find('[name="avg_cost"]').val()) || 0;
            const mrp = parseFloat(row.find('[name="mrp"]').val()) || 0;
            const conversionFactor = parseFloat(row.find('[name="conversion_factor"]').val()) || 1;
            const cDiscPercent = parseFloat(row.find('[name="c_disc_percent"]').val()) || 0;
            const schDiscPercent = parseFloat(row.find('[name="sch_disc_percent"]').val()) || 0;

            const totalQuantity = receivedQuantity * conversionFactor;
            const costAmount = totalQuantity * costPrice;
            const avgcostAmount = totalQuantity * avgCost;
            const amount = totalQuantity * mrp;
            const cDiscAmount = costAmount * (cDiscPercent / 100);
            const schDiscAmount = costAmount * (schDiscPercent / 100);

            const cgstPercent = parseFloat(row.find('[name="cgst_percent"]').val()) || 0;
            const sgstPercent = parseFloat(row.find('[name="sgst_percent"]').val()) || 0;
            const igstPercent = parseFloat(row.find('[name="igst_percent"]').val()) || 0;

            const cgstAmount = (costAmount - cDiscAmount - schDiscAmount) * (cgstPercent / 100);
            const sgstAmount = (costAmount - cDiscAmount - schDiscAmount) * (sgstPercent / 100);
            const igstAmount = (costAmount - cDiscAmount - schDiscAmount) * (igstPercent / 100);

            const netAmount = costAmount - cDiscAmount - schDiscAmount + cgstAmount + sgstAmount + igstAmount;

            row.find('[name="total_quantity"]').val(totalQuantity.toFixed(2));
            row.find('[name="cost_amount"]').val(costAmount.toFixed(2));
            row.find('[name="avg_cost_amount"]').val(avgcostAmount.toFixed(2));
            row.find('[name="amount"]').val(amount.toFixed(2));
            row.find('[name="c_disc_amount"]').val(cDiscAmount.toFixed(2));
            row.find('[name="sch_disc_amount"]').val(schDiscAmount.toFixed(2));
            row.find('[name="cgst_amount"]').val(cgstAmount.toFixed(2));
            row.find('[name="sgst_amount"]').val(sgstAmount.toFixed(2));
            row.find('[name="igst_amount"]').val(igstAmount.toFixed(2));
            row.find('[name="net_amount"]').val(netAmount.toFixed(2));

            // Accumulate totals for discounts and taxes
            totalNetAmount += netAmount;
            totalCgstAmount += cgstAmount;
            totalSgstAmount += sgstAmount;
            totalIgstAmount += igstAmount;
            totalCDiscAmount += cDiscAmount;
            totalSchDiscAmount += schDiscAmount;
        });

        // Adjust final net amount with other charges and GRN discount
        var totalAmount=totalNetAmount
        totalNetAmount = totalNetAmount + totalOtherCharges - totalGrnDiscount;

        // Update total fields
        $('#grn_total_amount').val(totalAmount.toFixed(2));
        $('#grn_cgst_amount').val(totalCgstAmount.toFixed(2));
        $('#grn_sgst_amount').val(totalSgstAmount.toFixed(2));
        $('#grn_igst_amount').val(totalIgstAmount.toFixed(2));
        $('#grn_c_disc_amount').val(totalCDiscAmount.toFixed(2));
        $('#grn_sch_disc_amount').val(totalSchDiscAmount.toFixed(2));
        $('#grn_net_amount').val(totalNetAmount.toFixed(2)); // Final net amount after all calculations
        console.log("Totals updated: ", { totalNetAmount, totalCgstAmount, totalSgstAmount, totalIgstAmount });
    }

    // Attach listeners to dynamic inputs and select changes
    $('#maintable, #grn_discount, #grn_other_charges').on('input change', 'input, select', function() {
      
        console.log("Input or select changed, triggering calculations.");
        updateCalculations();
    });
    $('#grn_other_charges, #grn_discount').on('change', function() {
    
        console.log("Changes detected in Other Charges or GRN Discount, recalculating...");
        updateCalculations();
    });
    

    // Perform initial calculation on page load
    updateCalculations();
});


function formatDate(dateString) {
    return dateString.split('T')[0];
}

// $('#grnForm').on('submit', function(e) {
//         e.preventDefault(); // Prevent the default form submission

//         var formData = new FormData(this); 
        
//         console.log(formData)
//         for (var pair of formData.entries()) {
//             console.log(pair[0]+ ': ' + pair[1]); 
//         }
//         // Create a FormData object passing the form element

//         $.ajax({
//             url: '/path/to/your/endpoint', // Replace with your server endpoint
//             type: 'POST',
//             data: formData,
//             contentType: false, // Important: Set to false because jQuery will set it automatically
//             processData: false, // Important: Do not process the data
//             success: function(response) {
//                 console.log('Success:', response);
//                 alert('Form submitted successfully!');
//             },
//             error: function(xhr, status, error) {
//                 console.error('Error:', error);
//                 alert('Failed to submit form!');
//             }
//         });
//     });

$('#saveGRNBtn').click(function () {
    let formData = {
        grn_no: $('#grn_no').val(),
        date: $('#date').val(),
        gate_entry_no: $('#gate_entry_no').val(),
        store: $('#store').val(),
        supplier: $('#supplier').val(),
        pay_mode: $('input[name="pay_mode"]:checked').val(),
        invoice_date: $('#invoice_date').val(),
        invoice_no: $('#invoice_no').val(),
        total_amount: $('#grn_total_amount').val(),
        sgst_amount: $('#grn_sgst_amount').val(),
        cgst_amount: $('#grn_cgst_amount').val(),
        igst_amount: $('#grn_igst_amount').val(),
        other_charges: $('#grn_other_charges').val(),
        c_disc_amount: $('#grn_c_disc_amount').val(),
        sch_disc_amount: $('#grn_sch_disc_amount').val(),
        grn_discount: $('#grn_discount').val(),
        net_amount: $('#grn_net_amount').val(),
        received_by: $('#grn_received_by').val(),
        remark: $('#grn_remark').val(),
        is_finalize: $('#is_finalize').prop('checked'),
        items: []
    };

    // Collecting each item row data
    $('#maintable tr').each(function () {
        var row = $(this);
        formData.items.push({
            item_name: row.find('[name="item_name"]').val(),
            batch_code: row.find('[name="batch_code"]').val(),
            expiry_date: row.find('[name="expiry_date"]').val(),
            bar_code: row.find('[name="bar_code"]').val(),
            uom: row.find('[name="uom"]').val(),
            received_quantity: row.find('[name="received_quantity"]').val(),
            uom_select: row.find('[name="uom_select"]').val(),
            s_uom: row.find('[name="s_uom"]').val(),
            conversion_factor: row.find('[name="conversion_factor"]').val(),
            total_quantity: row.find('[name="total_quantity"]').val(),
            available_stock: row.find('[name="available_stock"]').val(),
            cost_price: row.find('[name="cost_price"]').val(),
            cost_amount: row.find('[name="cost_amount"]').val(),
            avg_cost: row.find('[name="avg_cost"]').val(),
            avg_cost_amount: row.find('[name="avg_cost_amount"]').val(),
            mrp: row.find('[name="mrp"]').val(),
            abated_mrp: row.find('[name="abated_mrp"]').val(),
            amount: row.find('[name="amount"]').val(),
            c_disc_percent: row.find('[name="c_disc_percent"]').val(),
            c_disc_amount: row.find('[name="c_disc_amount"]').val(),
            sch_disc_percent: row.find('[name="sch_disc_percent"]').val(),
            sch_disc_amount: row.find('[name="sch_disc_amount"]').val(),
            cgst_percent: row.find('[name="cgst_percent"]').val(),
            cgst_amount: row.find('[name="cgst_amount"]').val(),
            sgst_percent: row.find('[name="sgst_percent"]').val(),
            sgst_amount: row.find('[name="sgst_amount"]').val(),
            igst_percent: row.find('[name="igst_percent"]').val(),
            igst_amount: row.find('[name="igst_amount"]').val(),
            net_amount: row.find('[name="net_amount"]').val(),
            remarks: row.find('[name="remarks"]').val(),
            rack: row.find('[name="rack"]').val(),
            shelf: row.find('[name="shelf"]').val(),
            bin: row.find('[name="bin"]').val(),
            item_code: row.find('[name="item_code"]').val()
        });
    });

    console.log('Form Data:', formData);
    
    // Perform AJAX request to save data
    axios.post('/palashinv/saveGRNData', formData, {
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(function (response) {
        console.log('Success:', response.data);
        $('#errordiv1').addClass('alert-success').removeClass('alert-danger').text('Saved Successfully').show();
        $('#grn_no').val(response.data.grnNo);
        alert('GRN saved successfully!');
    }).catch(function (error) {
        console.error('Error:', error);
        $('#errordiv1').removeClass('alert-success').addClass('alert-danger').text(error.response.data.message).show();
        alert('Failed to save GRN!');
    });
});

</script>
</body>
</html>
