<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>LifeLinkr</title>
    <%- include('../header'); -%>
</head>
<body>
    <!-- main content start -->
    <div class="main-content">
        <div class="row content-top-gap2">
            <div class="col-lg-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-white">
                    <a class="navbar-brand text-center mr-5" href="#">
                        <span class="dash-icon"><i class="fas fa-tachometer-alt"></i></span> Dashboard
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item active text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="far fa-user"></i></span> Master
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-exchange-alt"></i></span> Transaction
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-hand-holding-medical"></i></span> Patient 360
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-receipt"></i></span> Outside Receipt
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-file-invoice"></i></span> Outpatient Department
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-chart-line"></i></span> Analytics
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="far fa-clock"></i></span> Waiting List
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-wrench"></i></span> Administration
                                </a>
                            </li>
                            <li class="nav-item text-center">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-spinner"></i></span> Additional
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
        <!-- content -->
        <div class="container-fluid">
            <div class="chart">
                <div class="row">
                    <div class="col-lg-12 pl-lg-0 mt-2 ml-2">
                        <h4 class="primary">Opening Balance</h4>
                    </div>
                    <div class="col-lg-12 pl-lg-2 chart-grid">
                        <form>
                            <div class="card card_border">
                                <div class="">
                                    <!--Past your code here starts-->
                                    <div class="card">
                                        <div class="card-body pb-3 pt-2">
                                            <div class="form-row">
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group">
                                                        <label class="input__label">From Date</label>
                                                        <input name="from date" type="date" class="form-control input-style" placeholder="">
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group">
                                                        <label class="input__label">To Date</label>
                                                        <input name="to date" type="date" class="form-control input-style" placeholder="">
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group">
                                                        <label class="input__label">Clinic</label>
                                                        <select name="report_generated_by" class="form-control input-style">
                                                            <option>Select</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group">
                                                        <label class="input__label">Store</label>
                                                        <select name="report_generated_by" class="form-control input-style">
                                                            <option>Select</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group">
                                                        <label class="input__label">Item Group</label>
                                                        <select name="report_generated_by" class="form-control input-style">
                                                            <option>Select</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                    <div class="form-group">
                                                        <label class="input__label">Item Name</label>
                                                        <input name="item name" type="text" class="form-control input-style" placeholder="">
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-12">
                                                    <div class="form-group">
                                                        <button type="button" class="btn btn-style mt-4 btn-primary btn-style btn-change">
                                                            <strong><i class="fas fa-search"></i> Search</strong>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-12">
                                                    <div class="form-group">
                                                        <div class="col col-12 pr-xl-0 pl-xl-0 pt-2">
                                                            <div class="slidex">
                                                                <table id="opening-item" class="table2" >
                                                                    <thead>
                                                                        <tr>
                                                                            <th contenteditable="true">Item Group</th>
                                                                            <th contenteditable="true">Item Code</th>
                                                                            <th contenteditable="true">Item Name</th>
                                                                            <th contenteditable="true">Quantity</th>
                                                                            <th contenteditable="true">UOM</th>
                                                                            <th contenteditable="true">Batch Code</th>
                                                                            <th contenteditable="true">Expiry Date</th>
                                                                            <th contenteditable="true">Barcode</th>
                                                                            <th contenteditable="true">Base CP</th>
                                                                            <th contenteditable="true">Base MRP</th>
                                                                            <th contenteditable="true">Total CP</th>
                                                                            <th contenteditable="true">Discount On Sale (%)</th>
                                                                            <th contenteditable="true" style="min-width: 100px;">CGST (%)</th>
                                                                            <th contenteditable="true" style="min-width: 100px;">CGST Amount</th>
                                                                            <th contenteditable="true" style="min-width: 100px;">SGST (%)</th>
                                                                            <th contenteditable="true" style="min-width: 100px;">SGST Amount</th>
                                                                            <th contenteditable="true" style="min-width: 100px;">IGST (%)</th>
                                                                            <th contenteditable="true" style="min-width: 100px;">IGST Amount</th>
                                                                            <th contenteditable="true">Total Net CP</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="tbodyid">
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            <div class="form-check-label text-right">
                                                                <div class="radio mt-3 mr-0 pr-4">
                                                                    <label class="form-check-label pt-1">
                                                                        
                                                                    </label>
                                                                </div>
                                                                <button id="exportBtn" type="button" class="btn-secondary btn-style btn btn-change">
                                                                    <strong><i class="fa-solid fa-file-excel"></i> Export to Excel</strong>
                                                                </button>
                                                                <button type="button" class="btn-secondary btn-style btn btn-change ">
                                                                    <strong><i class="fa-solid fa-print"></i> Print Item Barcode</strong>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--Past your code here ends-->
                                </div>
                            </div>
                            <div class="form-group mt-1 mb-3 text-right">
                                <button type="button" id="printBtn" class="btn-secondary btn-style btn mt-3 mr-2">
                                    <strong><i class="fa-solid fa-print"></i> Print</strong>
                                </button>
                                <button type="button" onclick="window.location.href = '/palashinv/8';" class="btn-secondary btn-style btn mt-3 mr-2">
                                    <strong><i class="fa-solid fa-plus"></i> New</strong>
                                </button>
                                <button type="button" disabled class="btn-danger btn-style btn mt-3 mr-2">
                                    <strong><i class="fas fa-times"></i> Cancel</strong>
                                </button>
                                <button type="button" disabled class="btn-primary btn-style btn mt-3">
                                    <strong><i class="far fa-save"></i> Save</strong>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!--footer section start-->
        <%- include('../footer'); -%>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

        <script type="module">
            import { pagi_search } from '../javascripts/pagi_search.js';
        
            $(document).ready(function() {
                // Function to fetch data from the first route
                function fetchDataFromFirstRoute() {
                    return $.ajax({
                        url: '/palashinv/get-opening-balance',
                        type: 'GET'
                    });
                }
        
                // Function to fetch additional data based on item_id from the second route
                function fetchAdditionalData(itemId) {
                    return $.ajax({
                        url: `/palashinv/get-opening-balance-item/${itemId}`,  // Update this URL to your actual route
                        type: 'GET'
                    });
                }
        
                // Function to format date
                function formatDate(dateString) {
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                    return new Date(dateString).toLocaleDateString(undefined, options);
                }
        
                // Function to generate barcode
                function createBarcode(id1, id2) {
                    const code = `${id1}-${id2}`;
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    JsBarcode(svg, code, {
                        format: "CODE128",
                        displayValue: true,
                        fontSize: 18,
                        height: 100,
                        width: 2
                    });
                    svg.style.width = '150px';  // Fixed width
                    svg.style.height = '50px';  // Fixed height
                    return svg.outerHTML;
                }
        
                // Function to fetch and display data
                function fetchData() {
                    fetchDataFromFirstRoute()
                        .done(function(data) {
                            let tableRows = '';
                            let fetchPromises = [];
        
                            data.forEach(function(item) {
                                fetchPromises.push(
                                    fetchAdditionalData(item.id).then(function(additionalData) {
                                        // Merge item data with additional data
                                        const combinedItem = {
                                            ...item,
                                            item_group: additionalData.item_group,
                                            item_code: additionalData.item_code,
                                            item_name: additionalData.item_name,
                                            additional_id: additionalData.id
                                        };
        
                                        const barcode = createBarcode(item.id, additionalData.id);
        
                                        tableRows += `
                                            <tr data-ob-id="${combinedItem.id}">
                                                <td>${combinedItem.item_group}</td>
                                                <td>${combinedItem.item_code}</td>
                                                <td>${combinedItem.item_name}</td>
                                                <td>${combinedItem.total_quantity}</td>
                                                <td>${combinedItem.uom}</td>
                                                <td>${combinedItem.batch_code}</td>
                                                <td>${formatDate(combinedItem.expiry_date)}</td>
                                                <td>${barcode}</td>
                                                <td>${combinedItem.cp}</td>
                                                <td>${combinedItem.mrp}</td>
                                                <td>${combinedItem.total_cp}</td>
                                                <td>${combinedItem.discount_on_sale}</td>
                                                <td>${combinedItem.cgst}</td>
                                                <td>${combinedItem.cgst_amount}</td>
                                                <td>${combinedItem.sgst}</td>
                                                <td>${combinedItem.sgst_amount}</td>
                                                <td>${combinedItem.igst}</td>
                                                <td>${combinedItem.igst_amount}</td>
                                                <td>${combinedItem.total_net_cp}</td>
                                            </tr>
                                        `;
                                    })
                                );
                            });
        
                            // Once all fetches are done, update the table
                            $.when.apply($, fetchPromises).then(function() {
                                $('#tbodyid').html(tableRows);
                                pagi_search('#searchBox', '#opening-item', '#paginationControls');
                            });
                        })
                        .fail(function(xhr, status, error) {
                            console.error('Error fetching data:', error);
                        });
                }
        
                // Fetch data on page load
                fetchData();
        
                // Function to print the table with borders
                function printTable(tableID) {
                    var table = document.getElementById(tableID).outerHTML;
                    var newWin = window.open("");
                    newWin.document.write(`
                        <html>
                        <head>
                            <title>Print</title>
                            <style>
                                table, th, td {
                                    border: 1px solid black;
                                    border-collapse: collapse;
                                    padding: 8px;
                                }
                                th {
                                    background-color: #f2f2f2;
                                }
                                svg {
                                    width: 150px !important;  // Ensure fixed width for barcodes
                                    height: 50px !important;  // Ensure fixed height for barcodes
                                }
                            </style>
                        </head>
                        <body>
                            ${table}
                        </body>
                        </html>
                    `);
                    newWin.document.close();
                    newWin.print();
                    newWin.close();
                }
        
                // Add event listener to print button
                document.getElementById('printBtn').addEventListener('click', function() {
                    printTable('opening-item');
                });
            });
        </script>
        
        
        
        
</body>
</html>
