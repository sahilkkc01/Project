<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>LifeLinkr</title>
    <style>
        .slidx{display:block;overflow-x:auto;}
        .payment-div {
    display: none;
}
#paymentMethod {
    display: none;
}

    </style>

    <%- include('../header') %>        <!-- //header-ends -->
        <!-- main content start -->
        <div class="main-content">

            <div class="row content-top-gap2">
                <div class="col-lg-12">
                    <nav class="navbar navbar-expand-lg navbar-light bg-white">
                        <a class="navbar-brand text-center mr-5" href="#">
                            <span class="dash-icon"><i class="fas fa-tachometer-alt"></i></span>
                            Dashboard
                        </a>
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarNav">
                            <ul class="navbar-nav">
                                <li class="nav-item active text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="far fa-user"></i></span>
                                        Master
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-exchange-alt"></i></span>
                                        Transaction
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-hand-holding-medical"></i></span>
                                        Patient 360
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-receipt"></i></span>
                                        Outside Reciept
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-file-invoice"></i></span>
                                        Outpatient Department
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-chart-line"></i></span>
                                        Analytics
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="far fa-clock"></i></span>
                                        Waiting List
                                    </a>
                                </li>
                                <li class="nav-item text-center mr-5">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-wrench"></i></span>
                                        Adminstration
                                    </a>
                                </li>
                                <li class="nav-item text-center">
                                    <a class="nav-link" href="#">
                                        <span class="dash-icon"><i class="fas fa-spinner"></i></span>
                                        Additional
                                    </a>
                                </li>

                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
            <!-- content -->
            <div class="container-fluid">

                <div class="chart">
                    <div class="row">

                        <div class="col-lg-12 pl-lg-0 mt-2 ml-2">
                            <h4 class="primary">Bill Detail : <%= patient.prefix %>  <%= patient.firstName %></h4>
                        </div>

                        <div class="col-lg-12 pl-lg-2 chart-grid">
                            <div id="errordiv1"></div>
                            <form id="patientBill" method="post">
                                <input type="hidden" name="query" id="query" value="0">
                                <input type="hidden" name="itemid" id="itemid" value="<%= patient2.id %>">
                                <div class="card card_border">
                                    <div class="">

                                        <!--Past your code here starts-->

                                        <div class="card">

                                            <div class="mb-0">
                                                <div class="form-group">
                                                    <div class="col-xl-12 p-heading">
                                                        <!-- Nav Tabs are here once have a look--->
                                                        <h6 class="p-text">CLINICAL</h6>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card-body pb-0 pt-0 pl-lg-0 pr-lg-0">

                                                

                                                <div class="form-row">
                                                    <div class="col-12 pl-lg-0 pr-lg-0 pt-3">
                                                        <div class="form-group">
                                                            <div class="col col-12 pb-3 pr-lg-4 pl-lg-4">
                                                                <div class="slidx">

                                                                    <table class="table2">

                                                                        <thead>
                                                                            <tr>

                                                                                <th contenteditable="true">Service Code
                                                                                </th>
                                                                                <th contenteditable="true">Service Name
                                                                                </th>
                                                                                <th contenteditable="true">Rate</th>
                                                                                <th contenteditable="true">Quantity</th>
                                                                                <th contenteditable="true">Concession %
                                                                                </th>
                                                                                <th contenteditable="true">Concession
                                                                                    Amt.</th>
                                                                                <th contenteditable="true">Tax Amount
                                                                                </th>
                                                                                <th contenteditable="true">Total Amount
                                                                                </th>
                                                                                <th contenteditable="true">Net Amount
                                                                                </th>
                                                                                <th contenteditable="true">Doctor</th>





                                                                            </tr>
                                                                        </thead>

                                                                        <tbody id="serviceshow">
                                                                            <tr>

                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>






                                                                            </tr>

                                                                            <tr>

                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>
                                                                                <td contenteditable="true"> </td>





                                                                            </tr>
                                                                        </tbody>

                                                                    </table>
                                                                </div>



                                                            </div>

                                                            <div class="form-row card-body pt-1  pb-0">

                                                                <div class="col-lg-4 col-md-2 col-sm-12">
                                                                    <div class="form-group">

                                                                        <button type="button" 
                                                                            class="btn btn-style mt-4 btn-secondary btn-style btn-change ml-1 mr-2"><strong><i
                                                                                    class="fas fa-plus"></i>
                                                                                Add Prescribed Items</strong></button>


                                                                                <button type="button" data-bs-toggle="modal"
                                                                                data-bs-target="#myModal5" id="addOtherItem"
                                                                                    class="btn btn-style mt-4 btn-secondary btn-style btn-change"><strong><i
                                                                                            class="fas fa-plus"></i>
                                                                                        Add Package</strong></button>


                                                                        <button type="button" data-bs-toggle="modal"
                                                                        data-bs-target="#myModal" id="addOtherItem"
                                                                            class="btn btn-style mt-4 btn-secondary btn-style btn-change"><strong><i
                                                                                    class="fas fa-plus"></i>
                                                                                Add Other Items</strong></button>

                                                                    </div>
                                                                </div>

                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group"><label
                                                                            class="input__label">Total</label><input
                                                                            name="totalBillAmount" id="totalBillAmount" type="number"
                                                                            class="form-control input-style" disabled
                                                                            placeholder=""></div>
                                                                </div>

                                                                <div class="col-lg-2 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group"><label
                                                                            class="input__label">Concession</label><input
                                                                            name="totalConcessionAmount" id="totalConcessionAmount"type="text"
                                                                            class="form-control input-style"  disabled
                                                                            placeholder=""></div>
                                                                </div>

                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group"><label
                                                                            class="input__label">Net
                                                                            Amount</label><input name="totalNetAmount" id="totalNetAmount"
                                                                            type="text" class="form-control input-style" disabled
                                                                            placeholder=""></div>
                                                                </div>



                                                            </div>


                                                            
                                                        </div>
                                                    </div>
                                                </div>



                                            </div>
                                        </div>

                                        <!--Past your code here ends-->
                                    </div>





                                </div>


                                <div class="col-lg-12 pl-lg-0 pr-lg-0 mt-3">
                                    <div class="card card_border">




                                        <div class="form-row card-body  pt-2">

                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                <div class="form-group"><label class="input__label">Clinical
                                                        Bill</label><input name="clinicBillAmount" id="clinicBillAmount" type="text" disabled
                                                        class="form-control input-style" placeholder=""></div>
                                            </div>


                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                <div class="form-group"><label class="input__label">Total Net
                                                        Amount</label><input name="totalNetBillAmount" id="totalNetBillAmount" type="text" disabled
                                                        class="form-control input-style" placeholder=""></div>
                                            </div>


                                            <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                <div class="form-group"><label class="input__label">Pay
                                                        Amount</label><input name="totalPayAmount" id="totalPayAmount" type="text" disabled
                                                        class="form-control input-style" placeholder=""></div>
                                            </div>


                                            <div class="col-lg-3 col-md-4 col-sm-12">
                                                <div class="form-group"><label
                                                        class="input__label">Advance</label><input name="Advance" id="Advance" data-validation
                                                        type="text" class="form-control input-style" placeholder="">
                                                </div>
                                            </div>


                                            <div class="col-lg-3 col-md-4 col-sm-12">
                                                <div class="form-group"><label class="input__label">Remark</label><input data-validation
                                                        name="remarks" id="remarks" type="text" class="form-control input-style"
                                                        placeholder=""></div>
                                            </div>


                                            <div class="col-lg-3 col-md-4 col-sm-12">
                                                <div class="form-group"><label class="input__label">Concession
                                                        Reason</label><select name="ConcessionReason" disabled id="ConcessionReason" data-validation
                                                        class="form-control input-style">
                                                        <option value="Select">Select</option>
                                                    </select></div>
                                            </div>

                                            <div class="col-lg-4 col-md-4 col-sm-12">
                                                <div class="form-row">
                                                    <div class="radio mt-4 ">

                                                        <label class="form-check-label pt-1 pr-4"><input id="freeze" name="freeze"
                                                                class="form-check-input mt-1" type="checkbox">Freeze
                                                            Bill</label>

                                                    </div>

                                                </div>
                                            </div>




                                        </div>

                                        <div class="form-row card-body pt-0 pb-3">

                                            <div class="col-lg-3 col-md-4 col-sm-12">
                                                <label class="input__label">Against</label>
                                                <div class="form-row">
                                                    <div class="radio ">

                                                        <label class="form-check-label pt-1 pr-4"><input name="against" checked disabled    
                                                                class="form-check-input mt-1" type="radio">Bill</label>

                                                        <label class="form-check-label pt-1 pr-4 pl-4"><input name="against"
                                                                class="form-check-input mt-1" disabled
                                                                type="radio">Services</label>

                                                    </div>

                                                </div>
                                            </div>

                                            <div class="col-lg-3 col-md-4 col-sm-12">
                                                <label class="input__label">Option</label>
                                                <div class="form-row">
                                                    <div class="radio ">

                                                        <label class="form-check-label pt-1 pr-4"><input name="option" checked
                                                                class="form-check-input mt-1"
                                                                type="radio">Detail</label>

                                                        <label class="form-check-label pt-1 pr-4 pl-4"><input name="option" disabled
                                                                class="form-check-input mt-1"
                                                                type="radio">Inline</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-12 pl-lg-2 pr-lg-3">
                                            <div class="card card_border">
                                                <div>
                                                    <div class="form-group">
                                                        <div class="col-xl-12 p-heading">
                                                            <h6 class="p-text">FINANCIAL DETAILS</h6>
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <div class="card-body pt-1 pb-2">
                                                    <div class="form-row">
                                                        <div class="col-lg-3 col-md-4 col-sm-12 pl-0 text-left">
                                                            <div class="form-check-label">
                                                                <div class="radio">
                                                                    <label class="form-check-label pt-1 pr-4">
                                                                        <input id="paymentCash" class="form-check-input mt-1" type="radio" name="paymentMethod" value="cash" <%= !patient2.payerType ? 'checked' : '' %>>Cash
                                                                    </label>
                                                                    <label class="form-check-label pt-1 pr-4 pl-4">
                                                                        <input id="paymentCredit" class="form-check-input mt-1" type="radio" name="paymentMethod" value="credit" <%= patient2.payerType ? 'checked' : '' %>>Credit
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2" id="payerTypeContainer" >
                                                            <div class="form-group">
                                                                <label class="input__label">Payer Type</label>
                                                                <select id="payerTypeSelect" name="payerType" class="form-control input-style">
                                                                    <option value="">Select</option>
                                                                    <option value="insurance" <%= patient2.payerType === 'insurance' ? 'selected' : '' %>>Insurance / TPA</option>
                                                                    <option value="corporate" <%= patient2.payerType === 'corporate' ? 'selected' : '' %>>Corporate</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <!-- Section to be toggled based on payer type -->
                                                <div id="InsuranceDetails" class="card-body pt-2 pb-1">
                                                    <div class="form-row">
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Payer</label>
                                                                <select id="payer" name="payer" class="form-control input-style">
                                                                    <option value="">Select</option>
                                                                    <option value="a">a</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Ref. No.</label>
                                                                <input id="refNo" name="refNo" type="number" class="form-control input-style" placeholder="" value="<%= patient2.refNo || '' %>">
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Valid From</label>
                                                                <input id="validFrom" name="validFrom" type="date" class="form-control input-style" placeholder="" value="<%= patient2.validFrom || '' %>">
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Valid To</label>
                                                                <input id="validTo" name="validTo" type="date" class="form-control input-style" placeholder="" value="<%= patient2.validTo || '' %>">
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Remarks</label>
                                                                <textarea id="financialRemarks" name="financialRemarks" class="form-control input-style" placeholder="Max. 2000 letters"><%= patient2.financialRemarks || '' %></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <!-- Corporate specific section to be toggled -->
                                                <div id="corporateDetails" class="card-body pt-2 pb-2" >
                                                    <div class="form-row">
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Company</label>
                                                                <select id="company" name="company" class="form-control input-style">
                                                                    <option value="">Select</option>
                                                                    <option value="a" <%= patient2.company === 'a' ? 'selected' : '' %>>a</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Insurance</label>
                                                                <select id="insurance" name="insurance" class="form-control input-style">
                                                                    <option value="">Select</option>
                                                                    <option value="a" <%= patient2.insurance === 'a' ? 'selected' : '' %>>a</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Ref. No.</label>
                                                                <input id="refNoCorporate" name="refNo" type="number" class="form-control input-style" placeholder="" value="<%= patient2.refNoCorporate || '' %>">
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Valid From</label>
                                                                <input id="validFromCorporate" name="validFrom" type="date" class="form-control input-style" placeholder="" value="<%= patient2.validFromCorporate || '' %>">
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Valid To</label>
                                                                <input id="validToCorporate" name="validTo" type="date" class="form-control input-style" placeholder="" value="<%= patient2.validToCorporate || '' %>">
                                                            </div>
                                                        </div>
                                        
                                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                            <div class="form-group">
                                                                <label class="input__label">Remarks</label>
                                                                <textarea id="corporateRemarks" name="financialRemarks" class="form-control input-style" placeholder="Max. 2000 letters"><%= patient2.corporateRemarks || '' %></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2" id="cashRemarks">
                                                    <div class="form-group">
                                                        <label class="input__label">Remarks</label>
                                                        <textarea id="cashRemarksInput" name="remarks" class="form-control input-style" placeholder="Max. 2000 letters"><%= patient2.cashRemarks || '' %></textarea>
                                                    </div>
                                                </div>
                                        
                                                <div class="form-row card-body pt-0 pb-3">
                                                    <div class="col-lg-12 col-md-12 col-sm-12 pr-0 text-right">
                                                        <div class="form-check-label">
                                                            <div class="radio">
                                                                <label class="form-check-label pt-0">
                                                                    <input id="receivePaymentCheckbox" class="form-check-input mt-1" type="checkbox" name="receivePayment" <%= patient2.receivePayment ? 'checked' : '' %>>
                                                                    Receive Payment
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        
                                        

                                        <div class="col-lg-12 pl-lg-2 pr-lg-3 mt-3" id="paymentMethod">
                                            <div class="card card_border">
                                                <div>
                                                    <div class="form-group">
                                                        <div class="col-xl-12 p-heading">
                                                            <h6 class="p-text">PATIENT DETAILS</h6>
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <div class="form-row card-body pt-1 pb-2">
                                                    <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                        <div class="form-group">
                                                            <label class="input__label">Advance Payment</label>
                                                            <input id="advancePayment" name="advancePayment" type="number" class="form-control input-style" placeholder="0.00" value="<%= patient2.advancePayment || '' %>">
                                                        </div>
                                                    </div>
                                        
                                                    <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                        <div class="form-group">
                                                            <label class="input__label">Adjust Advance Payment</label>
                                                            <input id="adjustAdvancePayment" name="adjustAdvancePayment" type="number" class="form-control input-style" placeholder="" value="<%= patient2.adjustAdvancePayment || '' %>">
                                                        </div>
                                                    </div>
                                        
                                                    <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                        <div class="form-group">
                                                            <label class="input__label">Select Payment Mode</label>
                                                            <select id="paymentMode" name="paymentMethod" class="form-control input-style">
                                                                <option value="cash" <%= patient2.paymentMethod === 'cash' ? 'selected' : '' %>>Cash</option>
                                                                <option value="cheque" <%= patient2.paymentMethod === 'cheque' ? 'selected' : '' %>>Cheque</option>
                                                                <option value="card" <%= patient2.paymentMethod === 'card' ? 'selected' : '' %>>Card</option>
                                                                <option value="tt" <%= patient2.paymentMethod === 'tt' ? 'selected' : '' %>>TT</option>
                                                                <option value="ePayment" <%= patient2.paymentMethod === 'ePayment' ? 'selected' : '' %>>EPayment</option>
                                                                <option value="neft" <%= patient2.paymentMethod === 'neft' ? 'selected' : '' %>>NEFT / RTGS</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                        
                                                    <div class="col-lg-3 col-md-4 col-sm-12 mb-1">
                                                        <div class="form-row">
                                                            <div class="col-9">
                                                                <label class="input__label">Paid Amount (INR)</label>
                                                                <input id="paidAmount" name="paidAmount" type="number" class="form-control input-style" placeholder="0.00" value="<%= patient2.paidAmount || '' %>" disabled>
                                                            </div>
                                                            <div class="col-3">
                                                                <button type="button" id="addPaidAmount" class="btn btn-style btn-secondary mt-4 btn-style btn-change">
                                                                    <strong><i class="fa-solid fa-plus"></i> Add</strong>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <div class="form-row mt-0 mb-2">
                                                    <!-- NEFT / RTGS Payment Details -->
                                                    <div class="mt-1 col-lg-12 pl-xl-4 pr-xl-4 payment-div" id="neftDiv" >
                                                        <div class="card card_border">
                                                            <div class="form-row pl-lg-3 pr-lg-3 pb-2">
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Reference No.</label>
                                                                        <input id="referenceNo" name="referenceNo" type="number" class="form-control text-right input-style" placeholder="" value="<%= patient2.referenceNo || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Reference Date</label>
                                                                        <input id="referenceDate" name="referenceDate" type="date" class="form-control text-right input-style" placeholder="" value="<%= patient2.referenceDate || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Bank Name</label>
                                                                        <input id="bankName" name="bankName" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.bankName || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Bank Details</label>
                                                                        <input id="bankDetails" name="bankDetails" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.bankDetails || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Default Bank Account</label>
                                                                        <input id="defaultBankAccount" name="defaultBankAccount" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.defaultBankAccount || '' %>">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                        
                                                    <!-- Cheque Payment Details -->
                                                    <div class="mt-1 col-lg-12 pl-xl-4 pr-xl-4 payment-div" id="chequeDiv">
                                                        <div class="card card_border">
                                                            <div class="form-row pl-lg-3 pr-lg-3 pb-1">
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Cheque No.</label>
                                                                        <input id="chequeNo" name="chequeNo" type="number" class="form-control text-right input-style" placeholder="" value="<%= patient2.chequeNo || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Cheque Date</label>
                                                                        <input id="chequeDate" name="chequeDate" type="date" class="form-control text-right input-style" placeholder="" value="<%= patient2.chequeDate || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Bank Name</label>
                                                                        <input id="bankNameCheque" name="bankName" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.bankName || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Bank Details</label>
                                                                        <input id="bankDetailsCheque" name="bankDetails" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.bankDetails || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Default Bank Account</label>
                                                                        <input id="defaultBankAccountCheque" name="defaultBankAccount" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.defaultBankAccount || '' %>">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                        
                                                    <!-- E-Payment Details -->
                                                    <div class="mt-1 col-lg-12 pl-xl-4 pr-xl-4 payment-div" id="ePaymentDiv" >
                                                        <div class="card card_border">
                                                            <div class="form-row pl-lg-3 pr-lg-3 pb-2">
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Reference No.</label>
                                                                        <input id="referenceNoEPayment" name="referenceNo" type="number" class="form-control text-right input-style" placeholder="" value="<%= patient2.referenceNo || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Reference Date</label>
                                                                        <input id="referenceDateEPayment" name="referenceDate" type="date" class="form-control text-right input-style" placeholder="" value="<%= patient2.referenceDate || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">E-Payment Gateway Name</label>
                                                                        <input id="ePaymentGatewayName" name="ePaymentGatewayName" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.ePaymentGatewayName || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">E-payment Details</label>
                                                                        <input id="ePaymentDetails" name="ePaymentDetails" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.ePaymentDetails || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Default Bank Account</label>
                                                                        <input id="defaultBankAccountEPayment" name="defaultBankAccount" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.defaultBankAccount || '' %>">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                        
                                                    <!-- TT Payment Details -->
                                                    <div class="mt-1 col-lg-12 pl-xl-4 pr-xl-4 payment-div" id="ttDiv" >
                                                        <div class="card card_border">
                                                            <div class="form-row pl-lg-3 pr-lg-3 pb-2">
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Ref. No.</label>
                                                                        <input id="refNoTT" name="refNo" type="number" class="form-control text-right input-style" placeholder="" value="<%= patient2.refNo || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Transaction Date</label>
                                                                        <input id="transactionDateTT" name="transactionDate" type="date" class="form-control text-right input-style" placeholder="" value="<%= patient2.transactionDate || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Bank Name</label>
                                                                        <input id="bankNameTT" name="bankName" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.bankName || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Bank Details</label>
                                                                        <input id="bankDetailsTT" name="bankDetails" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.bankDetails || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Default Bank Account</label>
                                                                        <input id="defaultBankAccountTT" name="defaultBankAccount" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.defaultBankAccount || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Remarks</label>
                                                                        <textarea id="remarksTT" name="remarks" class="form-control input-style" placeholder=""><%= patient2.remarks || '' %></textarea>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                        
                                                    <!-- Card Payment Details -->
                                                    <div class="mt-1 col-lg-12 pl-xl-4 pr-xl-4 payment-div" id="cardDiv" >
                                                        <div class="card card_border">
                                                            <div class="form-row pl-lg-3 pr-lg-3 pb-2">
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Card Type</label>
                                                                        <select id="cardType" name="cardType" class="form-control input-style">
                                                                            <option value="Master" <%= patient2.cardType === 'Master' ? 'selected' : '' %>>Master</option>
                                                                            <option value="Rupay" <%= patient2.cardType === 'Rupay' ? 'selected' : '' %>>Rupay</option>
                                                                            <option value="Visa" <%= patient2.cardType === 'Visa' ? 'selected' : '' %>>Visa</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Card No.</label>
                                                                        <input id="cardNo" name="cardNo" type="number" class="form-control text-right input-style" placeholder="" value="<%= patient2.cardNo || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Card Holder Name</label>
                                                                        <input id="cardHolderName" name="cardHolderName" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.cardHolderName || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Approval No.</label>
                                                                        <input id="approvalNo" name="approvalNo" type="number" class="form-control text-right input-style" placeholder="" value="<%= patient2.approvalNo || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Bank Name</label>
                                                                        <input id="bankNameCard" name="bankName" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.bankName || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Bank Details</label>
                                                                        <input id="bankDetailsCard" name="bankDetails" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.bankDetails || '' %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Default Bank Account</label>
                                                                        <input id="defaultBankAccountCard" name="defaultBankAccount" type="text" class="form-control text-right input-style" placeholder="" value="<%= patient2.defaultBankAccount || '' %>">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <div class="form-row card-body pt-0 pb-1">  
                                                    <div class="col-lg-6 col-md-6 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Discount Remarks</label>
                                                            <textarea id="discountRemarks" name="discountRemarks" class="form-control input-style" placeholder=""><%= patient2.discountRemarks || '' %></textarea>
                                                        </div>
                                                    </div>
                                        
                                                    <div class="col-lg-6 col-md-6 col-sm-12">
                                                        <div class="form-group">
                                                            <label class="input__label">Bill Remarks</label>
                                                            <textarea id="billRemarks" name="billRemarks" class="form-control input-style" placeholder=""><%= patient2.billRemarks || '' %></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <div class="form-row card-body pt-0 pb-3">
                                                    <div class="col-lg-12 col-md-12 col-sm-12 pr-0 text-right">
                                                        <div class="form-check-label">
                                                            <div class="radio">
                                                                <label class="form-check-label pt-0">
                                                                    <input id="printBillOnConfirm" name="printBillOnConfirm" class="form-check-input mt-1" type="checkbox" <%= patient2.printBillOnConfirm ? 'checked' : '' %>>
                                                                    Print Bill on Confirm
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        
                                    </div>
                                </div>
                                <div class="form-group mt-1 mb-3 text-right">

                                    <button type="button" class="btn-secondary btn-style btn mt-3 mr-2" disabled><strong><i
                                                class="fas fa-check"></i> Approve</strong></button>

                                    <button type="button" class="btn-success btn-style btn mt-3 mr-2" id="mod-btn" onclick="updateQuery()"><strong><i
                                                class="fa-regular fa-pen-to-square"></i> Modify</strong></button>

                                    <button type="button" class="btn-secondary btn-style btn mt-3 mr-2" disabled><strong><i
                                                class="fa-solid fa-plus"></i> New</strong></button>

                                    <button type="button" class="btn-danger btn-style btn mt-3 mr-2" onclick="window.location.href='/plshBill/7'"><strong><i
                                                class="fas fa-times"></i> Cancel</strong></button>

                                    <button type="submit" id="submit"class="btn-primary btn-style btn mt-3"><strong><i
                                                class="far fa-save"></i>
                                            Save</strong></button>

                                </div>

                            </form>
                            <div id="loadingIndicator"></div>
                        </div>
                        <!--footer section start-->
                        

                        <div class="modal" id="myModal">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <!-- Modal Header -->
                                    <div class="modal-header">
                                        <a href="#" class="btn-close" data-bs-dismiss="modal"><i
                                                class="fa-solid fa-circle-xmark"></i></a>
                                    </div>

                                    <!-- Modal body -->
                                    <div class="modal-body">
                                        <div class="form-row">
                                            <div class="card-body pt-2 pb-2 pl-lg-3 pr-lg-3">
                                                <div class="form-row">
                                                    <div class="mt-1 col-lg-6 pl-lg-2">
                                                        <div class="card card_border">
                                                            <div class="mb-3">
                                                                <div class="form-group">
                                                                    <div class="col-xl-12 p-heading">
                                                                        <h6 class="p-text">LIST OF SERVICES</h6>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                    
                                                            <div class="form-row">
                                                                <div class="col-12 mb-1">
                                                                    <div class="form-group">
                                                                        <div class="pr-xl-0 pl-xl-3">
                                                                            <h6 class="primary">Advance Filter</h6>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                    
                                                            <div class="form-row pr-xl-3 pl-xl-3">
                                                                <div class="col-6 mb-3">
                                                                    <div class="form-group">
                                                                        <label class="input__label">Service Name</label>
                                                                        <input name="service_name" id="searchBox" type="text" class="form-control input-style" placeholder="" >
                                                                    </div>
                                                                </div>
                                                            </div>
                                                    
                                                            <div class="form-row">
                                                                <div class="col-12 mb-3 pl-lg-3 pr-lg-3">
                                                                    <div class="slidx">
                                                                        <table class="table2" id="servicesTable">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Select</th>
                                                                                    <th>Service Name</th>
                                                                                    <th>Service Code</th>
                                                                                    <th>Class Name</th>
                                                                                    <th>Service Rate</th>
                                                                                    <th>Concession Percentage</th>
                                                                                    <th>Concession Amount</th>
                                                                                    <th>Service Tax Percentage</th>
                                                                                    <th>Service Tax Amount</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody  id="tblbody">
                                                                               
                                                                            </tbody>
                                                                        </table>
                                                                        <div id="paginationControls"></div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-1 col-lg-6">
                                                        <div class="card card_border">
                                                            <div class="mb-3">
                                                                <div class="form-group">
                                                                    <div class="col-xl-12 p-heading">
                                                                        <h6 class="p-text">LIST OF SELECTED SERVICES</h6>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                    
                                                            <div class="form-row">
                                                                <div class="col-12 mb-3 pl-lg-3 pr-lg-3">
                                                                    <div class="slidx">
                                                                        <table class="table2" id="selectedServicesTable">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Service Name</th> 
                                                                                    <th>Service Code</th>  
                                                                                    <th>Class Name</th>
                                                                                    <th>Service Rate</th>
                                                                                    <th>Concession Percentage</th>
                                                                                    <th>Concession Amount</th> 
                                                                                    <th>Service Tax Percentage</th> 
                                                                                    <th>Service Tax Amount</th> 
                                                                                    <th>Delete</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody  id="servicetbody" >
                                                                                <tr hidden>
                                                                                    <td contenteditable="true" ></td>
                                                                                    <td contenteditable="true"></td>
                                                                                    <td contenteditable="true"></td>
                                                                                    <td contenteditable="true"> <button class="btn btn-danger btn-sm delete-btn td" data-service-name="">Delete</button></td>
                                                                                </tr>
                                                                                <tr hidden>
                                                                                    <td contenteditable="true"></td>
                                                                                    <td contenteditable="true"></td>
                                                                                    <td contenteditable="true"></td>
                                                                                    <td contenteditable="true"></td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    </div>
                                                <button type="button" id="addReferalDoc"
                                                    class="btn-secondary btn-style btn mt-3 mr-2">
                                                    <strong> Add</strong>
                                                </button>

                                                <button type="button" class="btn-danger btn-style btn mt-3"
                                                    data-bs-dismiss="modal">
                                                    <strong><i class="fas fa-times"></i> Close</strong>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>


                        <div class="modal" id="myModal5">
                            <div class="modal-dialog modal-lg">
                              <div class="modal-content">
                                <!-- Modal Header -->
                                <div class="modal-header">
                                Priscripotion
                                    <a href="#" class="btn-close" data-bs-dismiss="modal"><i class="fa-solid fa-circle-xmark"></i></a>
                                </div>
                          
                                <!-- Modal body -->
                                <div class="modal-body">
                                    <div class="row">
                                        <table id="prescriptionTable" class="table2">
                                            <thead>
                                                <tr>
                                                    <th>Id</th>
                                                    <th>Items</th>
                                                    <th>Date</th>
                                                </tr>
                                            </thead>
                                            <tbody id="prescriptionBody">
                                                <!-- Data will be appended here by Axios and jQuery -->
                                            </tbody>
                                        </table>
                                      </div>
                                </div>
                          
                              </div>
                            </div>
                        </div>
                        <%- include('../footer') %>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
    // Function to set display style based on condition
    function setDisplayStyle(selector, condition) {
        const elements = document.querySelectorAll(selector);
        elements.forEach(element => {
            element.style.display = condition ? 'block' : 'none';
        });
    }

    // Replace the inline styles with JavaScript conditions
    // Assuming `patient2.payerType` is available in your JS as `patientPayerType`
    const patientPayerType = '<%= patient2.payerType %>'; // Use server-side template to set initial value
    const isInsurance = patientPayerType === 'insurance';
    const isCorporate = patientPayerType === 'corporate';
    const isCash = !patientPayerType;

    setDisplayStyle('#payerTypeContainer', patientPayerType);
    setDisplayStyle('#InsuranceDetails', isInsurance);
    setDisplayStyle('#corporateDetails', isCorporate);
    setDisplayStyle('#cashRemarks', isCash);

    // You can add similar lines for other conditions where inline styles are used
    // Example for NEFT, Cheque, E-Payment, etc.
    const paymentMethod = '<%= patient2.paymentMethod %>';
    setDisplayStyle('#neftDiv', paymentMethod === 'neft');
    setDisplayStyle('#chequeDiv', paymentMethod === 'cheque');
    setDisplayStyle('#ePaymentDiv', paymentMethod === 'ePayment');
    setDisplayStyle('#ttDiv', paymentMethod === 'tt');
    setDisplayStyle('#cardDiv', paymentMethod === 'card');
});

// You can also use event listeners for form elements to dynamically update these styles
document.getElementById('paymentMode').addEventListener('change', function() {
    const selectedMode = this.value;
    const divs = ['neftDiv', 'chequeDiv', 'ePaymentDiv', 'ttDiv', 'cardDiv'];
    divs.forEach(div => {
        const element = document.getElementById(div);
        if (element) {
            element.style.display = selectedMode === div.replace('Div', '') ? 'block' : 'none';
        }
    });
});

                        </script>
<script>


$(document).ready(function() {

    $('#adjustAdvancePayment').on('input', function() {
    var advancePayment = parseFloat($('#advancePayment').val()) || 0;
    var adjustAdvancePayment = parseFloat($(this).val()) || 0;
    var totalNetBillAmount = parseFloat($('#totalNetBillAmount').val()) || 0;

    // Check if adjustAdvancePayment exceeds advancePayment or totalNetBillAmount
    if (adjustAdvancePayment > advancePayment || adjustAdvancePayment > totalNetBillAmount) {
        alert('Adjust Advance Payment cannot be more than Advance Payment or Total Net Bill Amount.');
        
        // Set the adjustAdvancePayment value to the smaller of the two limits (advancePayment or totalNetBillAmount)
        $(this).val(Math.min(advancePayment, totalNetBillAmount));
    }
});

$(document).ready(function() {
    $('#addPaidAmount').on('click',function() {
        // Get the values from the input fields
        var totalNetBillAmount = parseFloat($('#totalNetBillAmount').val()) || 0;
        var adjustAdvancePayment = parseFloat($('#adjustAdvancePayment').val()) || 0;

        // Calculate the difference
        var paidAmount = totalNetBillAmount - adjustAdvancePayment;

        // Set the calculated value to the Paid Amount input field
        $('#paidAmount').val(paidAmount.toFixed(2)); // Round to 2 decimal places
    });
});



    // Handle payment method radio buttons
    $('input[name="paymentMethod"]').change(function() {
        if ($(this).val() === 'credit') {
            $('#payerTypeContainer').show(); 
            $('#InsuranceDetails').hide();
            $('#corporateDetails').hide(); 
            $('#cashRemarks').hide(); 
            // Hide corporate details when credit is selected
        } else {
            
            $('#cashRemarks').show(); 
            $('#payerTypeContainer').hide();
            $('#InsuranceDetails').hide();
            $('#corporateDetails').hide(); // Hide corporate details if credit is not selected
        }
    });
    $('#payerTypeContainer').hide();
    // Handle payer type dropdown
    $('#payerTypeSelect').change(function() {
        if ($(this).val() === 'corporate') {
            $('#corporateDetails').show();
            $('#InsuranceDetails').hide(); // Hide credit details when corporate is selected
        } else {
            $('#InsuranceDetails').show();
            $('#corporateDetails').hide();
        }
    });
});


document.getElementById('receivePaymentCheckbox').addEventListener('change', function() {
    const paymentMethodDiv = document.getElementById('paymentMethod');
    if (this.checked) {
        paymentMethodDiv.style.display = 'block'; // Show the div when checked
    } else {
        paymentMethodDiv.style.display = 'none'; // Hide the div when unchecked
    }
});


    document.getElementById('paymentMode').addEventListener('change', function() {
    // Get the selected payment mode
    const selectedMode = this.value;

    // Hide all payment divs
    const paymentDivs = document.querySelectorAll('.payment-div');  
    paymentDivs.forEach(div => {
        div.style.display = 'none';
    });

    // Show the corresponding div based on selected mode, except for "Cash"
    if (selectedMode !== 'cash') {
        const selectedDiv = document.getElementById(selectedMode + 'Div');
        if (selectedDiv) {
            selectedDiv.style.display = 'block';
        }
    }
});



// $(document).ready(function() {
//             axios.get('/embrology/prescriptions')
//                 .then(function(response) {
//                     const prescriptions = response.data;
//                     prescriptions.forEach(function(prescription) {
//                         const items = prescription.prescribedMedicine.map(function(med) {
//                             return `Drug: ${med.Drug}, Dose: ${med.Dose}, Frequency: ${med.Frequency}, Days: ${med.Days}`;
//                         }).join('<br>');

//                         $('#prescriptionBody').append(`
//                             <tr>
//                                 <td>${prescription.id}</td>
//                                 <td>${items}</td>
//                                 <td>${prescription.Date}</td>
//                             </tr>
//                         `);
//                     });
//                 })
//                 .catch(function(error) {
//                     console.error('Error fetching prescriptions:', error);
//                 });
//         });


</script>
                        <script>
                            function updateQuery() {
                                document.getElementById('query').value=1;
                                $('#mod-btn').prop('disabled', true);
                                document.getElementById('submit').disabled = false;
                                $('input[data-validation], select[data-validation],#addOtherItem').prop('disabled', false);
                            }
                        
                            if ('<%= patient2.id %>' !== '') {
                                $('input[data-validation], select[data-validation],#addOtherItem').prop('disabled', true);
                            }
                            
                            if ('<%= patient2.status %>' !== 'true') {
                                document.getElementById('mod-btn').disabled = true;
                            }
                            
                            if ('<%= patient2.freeze %>' == 1) {
                                document.getElementById('mod-btn').disabled = true;
                                document.getElementById('submit').disabled = true;
                            } else {
                                document.getElementById('submit').disabled = false;
                               
                            }
                        </script>
                        
                         
                        <script>
                           $(document).ready(function () {
    var selectedServices = [];
    var selectedBillServices = [];

    try {
        // Correctly parse the JSON data from the server
        var rawJSON = `<%- JSON.stringify(patient2.selectedBillServices || []) %>`;
        selectedBillServices = JSON.parse(rawJSON);
    } catch (error) {
        console.error("Error parsing selectedBillServices JSON:", error);
        selectedBillServices = []; // Default to an empty array if parsing fails
    }

    async function populateSelectElement(
    tableName,
    fieldName,
    selectElementId, // Specific select element ID
    patient // Pass the patient object
) {
    try {
        console.log(patient); // To verify the patient object

        const response = await fetch(
            `/findpatient/getFieldValues?tableName=${tableName}&fieldName=${fieldName}`
        );
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }

        const data = await response.json();

        const selectElement = document.querySelector(selectElementId);

        if (selectElement) {
            // Clear existing options
            selectElement.innerHTML = '<option value="">Select</option>';

            // Populate select options
            data.forEach((item) => {
                const option = document.createElement("option");
                option.value = item.value; // Adjust this line based on the actual key in the response
                option.textContent = item.value; // Adjust this line based on the actual key in the response

                // Assuming the selectElementId includes the correct index to access the service
                const index = selectElementId.split('_').pop();
                if(patient){
                if (patient.selectedBillServices[index] && item.value === patient.selectedBillServices[index].doctor) {
                    option.selected = true; // Set this option as selected
                }}

                selectElement.appendChild(option);
            });
        }
    } catch (error) {
        console.error("Error populating select element:", error);
    }
}


    function fetchServices() {
        $.ajax({
            url: '/findpatient/get-service',
            method: 'GET',
            success: function (data) {
               
                populateServicesTable(data);
                markSelectedServices();
            },
            error: function (xhr, status, error) {
                console.error('Error fetching services:', xhr.responseText);
            }
        });
    }

    function populateServicesTable(services) {
        var $tblbody = $('#tblbody');
        $tblbody.empty(); // Clear existing rows

        services.forEach(function (service) {
            var checked = selectedServices.some(s => s.serviceName === service.serviceName) ? 'checked' : '';
            var row = `<tr>
                <td><input class="form-check-input mt-1" type="checkbox" ${checked}></td>
                <td>${service.serviceName}</td>
                <td>${service.serviceCode}</td>
                <td>${service.className}</td>
                <td>${service.baseServiceRate}</td>
                <td contenteditable="true">${service.concession_per || 0}</td>
                <td contenteditable="true">${service.concession_amount || 0}</td>
                <td contenteditable="true">${service.service_per || 0}</td>
                <td contenteditable="true">${service.service_amount || 0}</td>
            </tr>`;
            $tblbody.append(row);
        });

        attachCheckboxEventListeners(); // Attach event listeners to checkboxes
    }

    function attachCheckboxEventListeners() {
        $('#tblbody').on('change', 'input[type="checkbox"]', function () {
            var $row = $(this).closest('tr');
            var serviceName = $row.find('td:nth-child(2)').text().trim();
            var serviceCode = $row.find('td:nth-child(3)').text().trim();
            var className = $row.find('td:nth-child(4)').text().trim();
            var serviceRate = parseFloat($row.find('td:nth-child(5)').text().trim());
            var concession_per = $row.find('td:nth-child(6)').text().trim();
            var concession_amount = $row.find('td:nth-child(7)').text().trim();
            var service_per = $row.find('td:nth-child(8)').text().trim();
            var service_amount = $row.find('td:nth-child(9)').text().trim();

            if ($(this).is(':checked')) {
                selectedServices.push({
                    serviceName: serviceName,
                    serviceCode: serviceCode,
                    className: className,
                    serviceRate: serviceRate,
                    concession_per: concession_per,
                    concession_amount: concession_amount,
                    service_per: service_per,
                    service_amount: service_amount
                });
            } else {
                selectedServices = selectedServices.filter(service => service.serviceName !== serviceName);
            }

            updateServiceTbody(); // Update the selected services table
        });
    }

    function markSelectedServices() {
        $('#tblbody tr').each(function () {
            const $checkbox = $(this).find('input[type="checkbox"]');
            const rowServiceName = $(this).find('td:nth-child(2)').text().trim();
            const isSelected = selectedServices.some(service => service.serviceName === rowServiceName);

            if (isSelected) {
                $checkbox.prop('checked', true);
            }
        });

        updateServiceTbody();
    }
    

function updateServiceTbody() {
        const $servicetbody = $('#servicetbody');
        $servicetbody.empty();

        selectedServices.forEach((service, index) => {
            const newRow = `
                <tr>
                    <td>${service.serviceName}</td>
                    <td>${service.serviceCode}</td>
                    <td>${service.className}</td>
                    <td>${service.serviceRate}</td>
                    <td>${service.concession_per}</td>
                    <td>${service.concession_amount}</td>
                    <td>${service.service_per}</td>
                    <td>${service.service_amount}</td>
                    <td><button class="btn btn-danger delete-service" data-index="${index}">Delete</button></td>
                </tr>`;
            $servicetbody.append(newRow);
        });

        attachDeleteEventListeners(); // Attach event listeners to delete buttons
    }

    function attachDeleteEventListeners() {
    $('.delete-service').on('click', function () {
        const index = $(this).data('index');
        const serviceName = selectedServices[index].serviceName;

        // Remove the service from selectedServices array
        selectedServices.splice(index, 1);

        // Also remove the service from selectedBillServices array
        selectedBillServices = selectedBillServices.filter(service => service.serviceName !== serviceName);

        // Uncheck the checkbox in the services table
        $('#tblbody tr').each(function () {
            const $checkbox = $(this).find('input[type="checkbox"]');
            const rowServiceName = $(this).find('td:nth-child(2)').text().trim();
            if (rowServiceName === serviceName) {
                $checkbox.prop('checked', false);
            }
        });

        // Update the servicetbody with the remaining services
        updateServiceTbody();
    });
}

const patientData = '<%- JSON.stringify(patient2) %>';
const patient = JSON.parse(patientData);


function populateSelectedBillServices() {
    $('#serviceshow').empty();
console.log("se"+JSON.stringify(selectedBillServices))
    let totalBillAmount = 0;
    let totalConcessionAmount = 0;
    let totalNetAmount = 0;

    selectedBillServices.forEach(function (service, index) {
        console.log(service)
        var totalAmount = parseFloat(service.serviceRate) + parseFloat(service.service_amount || 0);
        var netAmount = parseFloat(totalAmount) - parseFloat(service.concession_amount || 0);

        totalBillAmount += totalAmount;
        totalConcessionAmount += parseFloat(service.concession_amount || 0);
        totalNetAmount += netAmount;

        var selectId = `doctorSelect_${index}`;
        var newRow = `<tr>
            <td>${service.serviceCode}</td>
            <td>${service.serviceName}</td>
            <td>${service.serviceRate}</td>
            <td contenteditable="true"><input type="number" id="quantity_${index}" class="form-control quantity-input" value="1" min="1"></td>
            <td contenteditable="true"><input type="number" id="concessionPer_${index}" class="form-control concession-per-input" value="${service.concession_per || 0}" min="0" max="100" step="0.01"></td>
            <td contenteditable="true"><input type="number" id="concessionAmount_${index}" class="form-control concession-amount-input" value="${service.concession_amount || 0}" step="0.01"></td>
            <td contenteditable="true"><input type="number" id="serviceAmount_${index}" class="form-control service-amount-input" value="${service.service_amount || 0}" step="0.01" readonly></td>
            <td id="totalAmount_${index}" contenteditable="true">${totalAmount.toFixed(2)}</td>
            <td id="netAmount_${index}" contenteditable="true">${netAmount.toFixed(2)}</td>
            <td contenteditable="true">
                <select id="${selectId}" class="form-control doctor-select" data-validation>
                    <option value="">Select Doctor</option>
                </select>
            </td>
        </tr>`;
        populateSelectElement("doctor", "doc_name", `#${selectId}`, patient);
      
        $('#serviceshow').append(newRow);

        // Attach event listeners for calculation adjustments
        $(`#concessionPer_${index}`).on('input', function () {
            calculateConcession(index, service.serviceRate);
        });

        $(`#concessionAmount_${index}`).on('input', function () {
            calculateConcession(index, service.serviceRate, true);
        });

        $(`#quantity_${index}`).on('input', function () {
            calculateConcession(index, service.serviceRate);
        });

        // Attach an event listener to capture the selected doctor
        $(`#${selectId}`).val(service.doctor || '').on('change', function () {
            var selectedDoctor = $(this).val();
            selectedBillServices[index].doctor = selectedDoctor; // Update the doctor in the array
        });
    });

    $('#totalBillAmount').val(totalBillAmount.toFixed(2));
    $('#clinicBillAmount').val(totalBillAmount.toFixed(2));
    $('#totalNetBillAmount').val(totalBillAmount.toFixed(2));
    $('#totalPayAmount').val(totalBillAmount.toFixed(2));
    $('#totalConcessionAmount').val(totalConcessionAmount.toFixed(2));
    $('#totalNetAmount').val(totalNetAmount.toFixed(2));

   
}

// Function to calculate concession based on percentage or amount
function calculateConcession(index, serviceRate, isAmountChange = false) {
    var quantity = parseFloat($(`#quantity_${index}`).val()) || 1;
    var concessionPer = parseFloat($(`#concessionPer_${index}`).val()) || 0;
    var concessionAmount = parseFloat($(`#concessionAmount_${index}`).val()) || 0;

    if (isAmountChange) {
        concessionPer = (concessionAmount / (serviceRate * quantity)) * 100;
        $(`#concessionPer_${index}`).val(concessionPer.toFixed(2));
    } else {
        concessionAmount = (serviceRate * quantity) * (concessionPer / 100);
        $(`#concessionAmount_${index}`).val(concessionAmount.toFixed(2));
    }

    var totalAmount = serviceRate * quantity;
    var netAmount = totalAmount - concessionAmount;

    $(`#serviceAmount_${index}`).val((serviceRate * quantity).toFixed(2));
    $(`#totalAmount_${index}`).text(totalAmount.toFixed(2));
    $(`#netAmount_${index}`).text(netAmount.toFixed(2));

    // Update totals
    updateTotals();
}

// Function to update the totals in the form
function updateTotals() {
    let totalBillAmount = 0;
    let totalConcessionAmount = 0;
    let totalNetAmount = 0;

    selectedBillServices.forEach(function (service, index) {
        totalBillAmount += parseFloat($(`#totalAmount_${index}`).text()) || 0;
        totalConcessionAmount += parseFloat($(`#concessionAmount_${index}`).val()) || 0;
        totalNetAmount += parseFloat($(`#netAmount_${index}`).text()) || 0;
    });

    $('#totalBillAmount').val(totalBillAmount.toFixed(2));
    $('#clinicBillAmount').val(totalBillAmount.toFixed(2));
    $('#totalNetBillAmount').val(totalNetAmount.toFixed(2));
    $('#totalPayAmount').val(totalNetAmount.toFixed(2));
    $('#totalConcessionAmount').val(totalConcessionAmount.toFixed(2));
    $('#totalNetAmount').val(totalNetAmount.toFixed(2));
}

$('#addReferalDoc').on('click', function () {
    // Add new services to selectedBillServices if they don't already exist
    selectedServices.forEach(function (service) {
        const serviceExists = selectedBillServices.some(existingService => existingService.serviceCode === service.serviceCode);

        if (!serviceExists) {
            var totalAmount = parseFloat(service.serviceRate) + parseFloat(service.service_amount || 0);
            var netAmount = parseFloat(totalAmount) - parseFloat(service.concession_amount || 0);

            selectedBillServices.push({
                serviceCode: service.serviceCode,
                serviceName: service.serviceName,
                serviceRate: service.serviceRate,
                concession_per: service.concession_per || 0,
                concession_amount: service.concession_amount || 0,
                service_amount: service.service_amount || 0,
                totalAmount: totalAmount || 0,
                netAmount: netAmount,
                doctor: ''
            });
        }
    });

    // Remove services from selectedBillServices if they are not in selectedServices
    selectedBillServices = selectedBillServices.filter(function (existingService) {
        return selectedServices.some(service => service.serviceCode === existingService.serviceCode);
    });

    // Optionally, you can call populateSelectedBillServices here to refresh the UI
    populateSelectedBillServices();
    $('#myModal').modal('hide');
});



$('#patientBill').on('submit', function (e) {
    e.preventDefault();


    var advancePayment = parseFloat($('#advancePayment').val()) || 0;
    var adjustAdvancePayment = parseFloat($('#adjustAdvancePayment').val()) || 0;

    if (adjustAdvancePayment > advancePayment) {
        alert('Adjust Advance Payment cannot be more than Advance Payment.');
        return false; // Prevent form submission
    }

    var formData = {
        query: $('#query').val(),
        itemid: $('#itemid').val(),
        totalBillAmount: $('#totalBillAmount').val(),
        totalConcessionAmount: $('#totalConcessionAmount').val(),
        totalNetBillAmount: $('#totalNetBillAmount').val(),
        totalNetAmount: $('#totalNetAmount').val(),
        clinicBillAmount: $('#clinicBillAmount').val(),
        totalPayAmount: $('#totalPayAmount').val(),
        remarks: $('#remarks').val(),
        Advance: $('#advancePayment').val(), // advancePayment field
        adjustAdvancePayment: $('#adjustAdvancePayment').val(),
        paymentMethod: $('#paymentMode').val(),
        paidAmount: $('#paidAmount').val(),
        referenceNo: $('#referenceNo').val(), // general reference number
        referenceDate: $('#referenceDate').val(), // general reference date
        bankName: $('#bankName').val(), // general bank name
        bankDetails: $('#bankDetails').val(), // general bank details
        defaultBankAccount: $('#defaultBankAccount').val(), // general bank account
        chequeNo: $('#chequeNo').val(), // cheque number
        chequeDate: $('#chequeDate').val(), // cheque date
        ePaymentGatewayName: $('#ePaymentGatewayName').val(), // e-payment gateway name
        ePaymentDetails: $('#ePaymentDetails').val(), // e-payment details
        transactionDate: $('#transactionDateTT').val(), // TT transaction date
        cardType: $('#cardType').val(), // card type
        cardNo: $('#cardNo').val(), // card number
        cardHolderName: $('#cardHolderName').val(), // card holder name
        approvalNo: $('#approvalNo').val(), // approval number
        discountRemarks: $('#discountRemarks').val(),
        billRemarks: $('#billRemarks').val(),
        printBillOnConfirm: $('#printBillOnConfirm').is(':checked'), // boolean value if checkbox is checked
        payerType: $('#payerTypeSelect').val(),
        payer: $('#payer').val(),
        refNo: $('#refNo').val(),
        validFrom: $('#validFrom').val(),
        validTo: $('#validTo').val(),
        financialRemarks: $('#financialRemarks').val(),
        company: $('#company').val(),
        insurance: $('#insurance').val(),
        refNoCorporate: $('#refNoCorporate').val(),
        validFromCorporate: $('#validFromCorporate').val(),
        validToCorporate: $('#validToCorporate').val(),
        corporateRemarks: $('#corporateRemarks').val(),
        cashRemarks: $('#cashRemarksInput').val(),
        mrNo: '<%= patient.mr_no %>', // assuming this is a server-side template value
        selectedBillServices: selectedBillServices, // assuming this is a variable from your script
        date: new Date().toISOString() // current date and time
    };

    $.ajax({
        url: '/findpatient/billPatientSubmit', 
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
            alert('Form submitted successfully!');
        },
        error: function (xhr, status, error) {
            alert('Error in saving form');
        }
    });
});


    populateSelectedBillServices();
    fetchServices();
});
</script>
                        