<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>LifeLinkr</title>
    <%- include('../header') %>
</head>

<body>
    <!-- main content start -->
    <div class="main-content">
        <div class="row content-top-gap2">
            <div class="col-lg-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-white">
                    <a class="navbar-brand text-center mr-5" href="#">
                        <span class="dash-icon"><i class="fas fa-tachometer-alt"></i></span>
                        Dashboard
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item active text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="far fa-user"></i></span>
                                    Master
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-exchange-alt"></i></span>
                                    Transaction
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-hand-holding-medical"></i></span>
                                    Patient 360
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-receipt"></i></span>
                                    Outside Receipt
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-file-invoice"></i></span>
                                    Outpatient Department
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-chart-line"></i></span>
                                    Analytics
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="far fa-clock"></i></span>
                                    Waiting List
                                </a>
                            </li>
                            <li class="nav-item text-center mr-5">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-wrench"></i></span>
                                    Administration
                                </a>
                            </li>
                            <li class="nav-item text-center">
                                <a class="nav-link" href="#">
                                    <span class="dash-icon"><i class="fas fa-spinner"></i></span>
                                    Additional
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>

        <!-- content -->
        <div class="container-fluid">
            <div class="chart">
                <div class="row">
                    <div class="col-lg-12 pl-lg-0 mt-2 ml-2">
                        <h4 class="primary">Patient Detail: Refund Patient Advance</h4>
                    </div>

                    <div class="col-lg-12 pl-lg-2 chart-grid">

                        <div class="card card_border">
                            <div class="">

                                <!--Past your code here starts-->

                                <div class="card">
                                    <div class="mb-0">
                                        <div class="form-group">
                                            <div class="col-xl-12 p-heading">
                                                <h6 class="p-text">REFUND LIST</h6>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card-body pb-0 pt-0 pl-lg-0 pr-lg-0">
                                        <div class="form-row">
                                            <div class="col-12 pl-lg-0 pr-lg-0 pt-3">
                                                <div class="form-group">
                                                    <div class="col col-12 pb-3 pr-lg-4 pl-lg-4">
                                                        <div class="slidx">
                                                            <table class="table2" id="patitentRefTable">
                                                                <thead>
                                                                    <tr>
                                                                        <th contenteditable="true">Receipt No.</th>
                                                                        <th contenteditable="true">Clinic</th>
                                                                        <th contenteditable="true">Refund Date</th>
                                                                        <th contenteditable="true">Refund Amount</th>
                                                                        <th contenteditable="true">Advance Receipt No.</th>
                                                                        <th contenteditable="true">Remarks</th>
                                                                        <th contenteditable="true">Freeze</th>
                                                                        <th contenteditable="true">Approve</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="patitentRef">

                                                                </tbody>
                                                            </table>
                                                        </div>
                                                        <div id="paginationControls"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!--Past your code here ends-->

                            </div>
                        </div>

                        <div class="mt-1 col-lg-12 pl-lg-0 pr-lg-0 mt-3">
                            <div class="card card_border">
                                <div class="mb-0">
                                    <div class="form-group">
                                        <div class="col-xl-12 p-heading">
                                            <h6 class="p-text">LIST OF ADVANCES</h6>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="col-12 pl-lg-0 pr-lg-0 pt-3">
                                        <div class="form-group">
                                            <div class="col col-12 pb-3 pr-lg-4 pl-lg-4">
                                                <div class="slidex">
                                                    <table class="table2" id="patitentAdvTable">
                                                        <thead>
                                                            <tr>
                                                                <th contenteditable="true">Date </th>
                                                                <th contenteditable="true">Receipt No.</th>
                                                                <th contenteditable="true">Clinic</th>
                                                                <th contenteditable="true">Total Amt.</th>
                                                                <th contenteditable="true">Consume Amt.</th>
                                                                <th contenteditable="true">Bal. Amt.</th>
                                                                <th contenteditable="true">Mode</th>
                                                                <th contenteditable="true">Transaction No.</th>
                                                                <th contenteditable="true">Cheque No.</th>
                                                                <th contenteditable="true">Bank Name</th>
                                                                <th contenteditable="true">Expiry Date</th>
                                                                <th contenteditable="true">Payment App</th>
                                                                <th contenteditable="true">Card Last 4 Digit</th>
                                                                <th contenteditable="true">Finance Company</th>
                                                                <th contenteditable="true">Remark</th>
                                                                   
                                                            </tr>
                                                        </thead>
                                                        <tbody id="patitentAdv">

                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div id="paginationControls"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <form id="patientRefund">
                            <div id="errordiv1"></div>
                            <input type="hidden" name="adv_rec_no" id="adv_rec_no">
                            <div class="mt-1 col-lg-12 pl-lg-0 pr-lg-0 mt-3">
                                <div class="card card_border">
                                    <div class="mb-0">
                                        <div class="form-group">
                                            <div class="col-xl-12 p-heading">
                                                <h6 class="p-text">ADD REFUND</h6>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-row card-body pt-2 pb-2">
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group">
                                                <label class="input__label">Refund Amount(Rs.)</label>
                                                <input name="refundAmount" id="refundAmount" type="number"
                                                    class="form-control input-style" placeholder=""
                                                    data-validation="required"
                                                    data-error-message="Refund Amount is required." <%=Id ? ''
                                                    :'disabled' %>>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group">
                                                <label class="input__label">Total Advance(Rs.)</label>
                                                <input name="totalAdvance" type="number" disabled id="totalAdvance"
                                                    class="form-control input-style" placeholder=""
                                                    data-validation="required"
                                                    data-error-message="Total Advance is required." <%=Id ? ''
                                                    :'disabled' %>>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group">
                                                <label class="input__label">Advance Consumed(Rs.)</label>
                                                <input name="advanceConsumed" id="advanceConsumed" type="number" readonly
                                                    class="form-control input-style" placeholder=""
                                                    data-validation="required"
                                                    data-error-message="Advance Consumed is required." >
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group">
                                                <label class="input__label">Total Refund</label>
                                                <input name="totalRefund" id="totalRefund" type="number" class="form-control input-style"
                                                    placeholder="" data-validation="required" readonly
                                                    data-error-message="Total Refund is required." <%=Id ? ''
                                                    :'disabled' %>>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-12 mb-2">
                                            <div class="form-group">
                                                <label class="input__label">Advance Available for Refund</label>
                                                <input name="advanceAvailable" id="advanceAvailable" type="number" disabled
                                                    class="form-control input-style" placeholder=""
                                                    data-validation="required"
                                                    data-error-message="Advance Available for Refund is required." >
                                            </div>
                                        </div>
                                        <div class="col-lg-12 col-md-12 col-sm-12 mb-2">
                                            <div class="form-group">
                                                <label class="input__label">Reason For Refund</label>
                                                <textarea name="remarks" class="form-control input-style" placeholder=""
                                                    data-validation="required"
                                                    data-error-message="Remarks are required."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mt-1 mb-3 text-right">
                                <!-- <button type="button" class="btn-secondary btn-style btn mt-3 mr-2">
                                    <strong><i class="fas fa-check"></i> Approve</strong>
                                </button> -->
                                <button type="submit" class="btn-secondary btn-style btn mt-3 mr-2">
                                    <strong><i class="fas fa-check"></i> Send For Approval</strong>
                                </button>
                                <button type="button" class="btn-danger btn-style btn mt-3 mr-2">
                                    <strong><i class="fas fa-times"></i> Cancel</strong>
                                </button>
                                <button type="button" class="btn-primary btn-style btn mt-3">
                                    <strong><i class="far fa-save"></i> Save</strong>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- footer section start -->
        <%- include('../footer') %>

            <script type="module">
                import { pagi_search } from '../javascripts/pagi_search.js';
                import { validateForm } from '../javascripts/validation.js';
                import { myAjax } from '../javascripts/myAjax.js';

              
                $(document).ready(function () {
                    console.log("Document is ready");
                    let patientAdvance
                    let newPatientRefund
                    // Function to fetch and display data
                    
                   
                    function fetchPatientAdvances() {
    $.ajax({
        url: '/plshBill/getCompanyAdvance',
        type: 'GET',
        success: function(data) {
			console.log(data)
            let tableRows = '';
            data.Advances.reverse().forEach(function(item) {
                console.log(item);
                tableRows += `
                    <tr data-store-id="${item.id}">
                    <td>${item.date}</td>
                    <td>${item.rec_no}</td>
                    <td>${item.clinic_name}</td>
                    <td>${item.amount || '0'}</td>
                    <td>${item.consume_amount || '0'}</td>
                    <td>${item.balance_amount || '0'}</td>
                    <td>${item.paymentMethod}</td>
                    <td>TRANS NO X</td>
                    <td>${item.chequeNo || ''}</td>
                    <td>${item.bankName}</td>
                    <td>EXPIRY DATE X</td>
                    <td>PAYMENT APP X</td>
                    <td>${item.cardNo || ''}</td>
                    <td>FIN COM X</td>
                    <td>${item.remarks}</td>
                    </tr>;
                `;
            });
            $('#patitentAdv').html(tableRows);
            // Consider re-enabling pagination if needed
            // pagi_search('#searchBox', '#patitentAdvTable', '#paginationControls');
        },
        error: function(xhr, status, error) {
            console.error('Error fetching patient advances:', error);
        }
    });
}
fetchPatientAdvances();

function fetchPatientRefunds() {
    $.ajax({
        url: '/plshBill/getCompanyRefund',
        type: 'GET',
        success: function(data) {
            let tableRows = '';
            data.patientRefunds.reverse().forEach(function(item) {
                console.log(item);
                tableRows += `
                    <tr data-store-id="${item.id}">
                    <td>${item.rec_no}</td>
                    <td>${item.clinic_name}</td>
                    <td>${item.refund_date}</td>
                    <td>${item.refundAmount}</td>
                    <td>${item.Adv_recipt_no}</td>
                    <td>${item.remarks}</td>
                    <td><input class="form-check-input mt-0"  type="checkbox"  ${item.freeze ? 'checked' : ''} ${!item.isApprove ? 'disabled' : ''}></td>
                    <td><input class="form-check-input mt-0"  type="checkbox" disabled ${item.isApprove ? 'checked' : ''}></td>
                    
                    </tr>
                `;
            });
            $('#patitentRef').html(tableRows);
            // Re-enable pagination if needed
            pagi_search('#searchBox', '#patitentRefTable', '#paginationControls');
        },
        error: function(xhr, status, error) {
            console.error('Error fetching patient refunds:', error);
        }
    });
}
fetchPatientRefunds()


                    

                    $('#patientRefund').on('submit', function (event) {
                        event.preventDefault();
                        submitForms();
                    });

                    // Function to submit forms
                    const submitForms = () => {
                        const patientFormDetails = validateForm('#patientRefund');
                        const { isValid: patientFormValid, errorMessage: patientFormError, formData: patientFormData } = patientFormDetails;
                        console.log(patientFormData);

                        const errorDivId = '#errordiv1';
                        if (patientFormValid) {
                            const url = '/plshBill/company-refaund-form-submit';
                            const loadingDiv = '#loadingDiv';
                           
                            $(loadingDiv).show();

$.ajax({
    url: url,
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(patientFormData),
    beforeSend: function() {
        // Show loading spinner or text
        $(loadingDiv).text('Loading...').show();
    },
    success: function(response) {
        // Hide loading indicator on success
        $(loadingDiv).hide();

        fetchPatientRefunds()
        alert('Form submitted successfully!');
        $(errorDivId).removeClass('alert-danger').addClass('alert-success').text('Form submitted successfully!').show();
        console.log('abc:', response);
        return response;
        
    },
    error: function(xhr, status, error) {
        // Hide loading indicator on error
        $(loadingDiv).hide();
        alert('Error in saving form');
        const response = JSON.parse(xhr.responseText);
        $(errorDivId).removeClass('alert-success').addClass('alert-danger').text(response.msg).show();
        console.error('Error:', error);
    }
});
                        } else {
                            alert(patientFormError);
                            $(errorDivId).removeClass('alert-success').addClass('alert-danger').text(patientFormError).show();
                        }
                    };
                });

                $('#patitentAdv').on('click', 'tr', function() {
    const rec_id = $(this).find('td:eq(1)').text();
    const adv_amt = $(this).find('td:eq(3)').text();
    const cons_amt = $(this).find('td:eq(4)').text();
    const bal_amount = $(this).find('td:eq(5)').text();
  $('#adv_rec_no').val(rec_id);
  $('#totalAdvance').val(adv_amt);
  $('#advanceConsumed').val(cons_amt);
  $('#advanceAvailable').val(bal_amount);
  $('#totalRefund').val('0');

  $('#patitentAdv tr').removeClass('locked');
  $(this).addClass('locked');
});

$('#refundAmount').on('change',function(){
                    let newValue = $(this).val();
                    let Adv_avl = $('#advanceAvailable').val()
                    
                    if(newValue>Adv_avl){
                        alert("Refund is more then available amount");
                        $('#refundAmount').val('0');
                    }
                    
                })
        
            </script>